<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Workout Tracker - GetNerdyIn30</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'JetBrains Mono', monospace; -webkit-font-smoothing: antialiased; }
  #root { min-height: 100vh; }
</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>

<!-- React -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
// â”€â”€â”€ Firebase Setup â”€â”€â”€
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyClaFN6GEpbheA7uSlOSSKKYBUntukG1Qs",
  authDomain: "getnerdyin30-tracker.firebaseapp.com",
  projectId: "getnerdyin30-tracker",
  storageBucket: "getnerdyin30-tracker.firebasestorage.app",
  messagingSenderId: "726007897188",
  appId: "1:726007897188:web:82b7c6a966d50b98cd5371",
  measurementId: "G-HCC427Q6C9"
};

firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.firestore();
db.enablePersistence({ synchronizeTabs: true }).catch(err => {
  if (err.code === "failed-precondition") console.warn("Offline persistence unavailable: multiple tabs open");
  else if (err.code === "unimplemented") console.warn("Offline persistence not supported in this browser");
});
const googleProvider = new firebase.auth.GoogleAuthProvider();

const loadData = async (uid) => {
  try {
    const snap = await db.collection("users").doc(uid).collection("data").doc("workouts").get();
    return snap.exists ? snap.data() : null;
  } catch (e) { console.error("Load failed:", e); return null; }
};

const saveData = async (uid, data) => {
  try {
    await db.collection("users").doc(uid).collection("data").doc("workouts").set(data);
  } catch (e) { console.error("Save failed:", e); }
};

const saveActiveWorkoutDraft = async (uid, workout) => {
  try {
    if (workout) {
      await db.collection("users").doc(uid).collection("data").doc("activeDraft").set(workout);
    } else {
      await db.collection("users").doc(uid).collection("data").doc("activeDraft").delete();
    }
  } catch (e) { console.error("Draft save failed:", e); }
};

const loadActiveWorkoutDraft = async (uid) => {
  try {
    const snap = await db.collection("users").doc(uid).collection("data").doc("activeDraft").get();
    return snap.exists ? snap.data() : null;
  } catch (e) { console.error("Draft load failed:", e); return null; }
};

const { useState, useEffect, useCallback } = React;

// Component code starts here
// â”€â”€â”€ Default exercise library â”€â”€â”€
const DEFAULT_EXERCISES = [
  { id: "rdl", name: "DB Romanian Deadlift", category: "posterior", muscle: "Hamstrings / Glutes", videoUrl: "https://www.muscleandstrength.com/exercises/stiff-leg-deadlift-aka-romanian-deadlift.html" },
  { id: "lat-pull", name: "Lat Pulldown", category: "back", muscle: "Lats", videoUrl: "https://www.muscleandstrength.com/exercises/lat-pull-down.html" },
  { id: "seated-row", name: "Seated Row", category: "back", muscle: "Mid Back", videoUrl: "https://www.muscleandstrength.com/exercises/seated-row.html" },
  { id: "pull-through", name: "Cable Pull-Through", category: "posterior", muscle: "Glutes / Hamstrings", videoUrl: "https://www.muscleandstrength.com/exercises/cable-pull-through.html" },
  { id: "kickback", name: "Single-Leg Cable Kickback", category: "posterior", muscle: "Glutes", videoUrl: "https://www.muscleandstrength.com/exercises/cable-glute-kickback.html" },
  { id: "face-pull", name: "Standing Face Pull", category: "back", muscle: "Rear Delts / Traps", videoUrl: "https://www.muscleandstrength.com/exercises/face-pull" },
  { id: "plank-pass", name: "Plank Pass-Through", category: "core", muscle: "Core", videoUrl: "https://www.muscleandstrength.com/exercises/plank-plate-pass" },
  { id: "front-squat", name: "DB Front Squat", category: "legs", muscle: "Quads", videoUrl: "https://www.muscleandstrength.com/exercises/dumbbell-goblet-squat" },
  { id: "incline-bench", name: "Incline DB Bench Press", category: "push", muscle: "Upper Chest", videoUrl: "https://www.muscleandstrength.com/exercises/incline-dumbbell-bench-press.html" },
  { id: "sl-leg-press", name: "Single-Leg Seated Leg Press", category: "legs", muscle: "Quads", videoUrl: "https://www.muscleandstrength.com/exercises/single-leg-leg-press" },
  { id: "cable-fly-high", name: "Cable Fly (High)", category: "push", muscle: "Chest", videoUrl: "https://www.muscleandstrength.com/exercises/standing-cable-fly.html" },
  { id: "cable-fly-mid", name: "Cable Fly (Mid)", category: "push", muscle: "Chest", videoUrl: "https://www.muscleandstrength.com/exercises/standing-cable-fly.html" },
  { id: "cable-fly-low", name: "Cable Fly (Low)", category: "push", muscle: "Lower Chest", videoUrl: "https://www.muscleandstrength.com/exercises/low-cable-fly" },
  { id: "leg-press", name: "Leg Press", category: "legs", muscle: "Quads / Glutes", videoUrl: "https://www.muscleandstrength.com/exercises/leg-press.html" },
  { id: "bb-bench", name: "Barbell Bench Press", category: "push", muscle: "Chest", videoUrl: "https://www.muscleandstrength.com/exercises/barbell-bench-press.html" },
  { id: "hip-thrust", name: "Smith Machine Hip Thrust", category: "posterior", muscle: "Glutes", videoUrl: "https://www.muscleandstrength.com/exercises/smith-machine-hip-thrust" },
  { id: "pull-up", name: "Assisted Pull-Up", category: "back", muscle: "Lats / Biceps", videoUrl: "https://www.muscleandstrength.com/exercises/machine-assisted-pull-up.html" },
  { id: "shoulder-press", name: "Seated DB Shoulder Press", category: "push", muscle: "Shoulders", videoUrl: "https://www.muscleandstrength.com/exercises/seated-dumbbell-press.html" },
  { id: "kb-swing", name: "Russian KB Swing", category: "posterior", muscle: "Posterior Chain", videoUrl: "https://www.muscleandstrength.com/exercises/one-arm-kettlebell-swing.html" },
  { id: "farmer-carry", name: "Farmer Carry", category: "carry", muscle: "Full Body / Grip", videoUrl: "https://www.muscleandstrength.com/exercises/farmers-walk" },
  { id: "suitcase-carry", name: "Suitcase Carry", category: "carry", muscle: "Core / Grip", videoUrl: "https://www.muscleandstrength.com/exercises/suitcase-carry" },
  { id: "db-row", name: "Single-Arm DB Row", category: "back", muscle: "Lats / Mid Back", videoUrl: "https://www.muscleandstrength.com/exercises/one-arm-dumbbell-row.html" },
  // Cardio
  { id: "spin", name: "Spin / Cycling", category: "cardio", muscle: "Legs / Cardio", isCardio: true },
  { id: "rowing", name: "Rowing", category: "cardio", muscle: "Full Body / Cardio", isCardio: true },
  { id: "treadmill-run", name: "Treadmill Run", category: "cardio", muscle: "Legs / Cardio", isCardio: true },
  { id: "outdoor-run", name: "Outdoor Run", category: "cardio", muscle: "Legs / Cardio", isCardio: true },
  { id: "walk", name: "Walk", category: "cardio", muscle: "Low Impact / Cardio", isCardio: true },
  { id: "elliptical", name: "Elliptical", category: "cardio", muscle: "Full Body / Cardio", isCardio: true },
  { id: "stair-climber", name: "Stair Climber", category: "cardio", muscle: "Legs / Glutes", isCardio: true },
];

const CATEGORY_COLORS = {
  posterior: { accent: "#e94560", label: "Posterior Chain" },
  back: { accent: "#0ea5e9", label: "Back" },
  push: { accent: "#f59e0b", label: "Push" },
  legs: { accent: "#22c55e", label: "Legs" },
  core: { accent: "#8b5cf6", label: "Core" },
  carry: { accent: "#ec4899", label: "Carry" },
  cardio: { accent: "#ff6b35", label: "Cardio" },
};

const APP_VERSION = "0.10";
const APP_BUILD_DATE = "2026-02-18";
const CHANGELOG = [
  { version: "0.10", date: "2026-02-18", changes: [
    "Duplicate planned workout to another date (copy icon on dashboard)",
    "Plan Again â€” convert any completed workout into a planned workout from history",
    "Templates now support warmup & cooldown notes",
  ]},
  { version: "0.09", date: "2026-02-18", changes: [
    "Exercise swap â€” tap the swap icon mid-workout to see alternatives by muscle group",
    "Active workout overwrite protection â€” warns before replacing an in-progress workout",
  ]},
  { version: "0.08", date: "2026-02-18", changes: [
    "Offline mode â€” app loads instantly from local cache, syncs when connected",
  ]},
  { version: "0.07", date: "2026-02-18", changes: [
    "Warmup & cooldown notes on every workout",
    "Planned workouts â€” plan specific dates from calendar",
    "Plan editor â€” tap to review/edit before starting",
    "Template editor â€” edit name, exercises, weights",
    "Weight selection in planner (warmup, working, sets, reps)",
    "Exercise ordering with up/down arrows",
    "Active workout auto-save (survives crashes & reloads)",
    "Light mode readability improvements",
    "Today badge timezone fix",
    "Calendar future month navigation",
    "Updated help guide",
    "Version tracking & changelog",
  ]},
  { version: "0.06", date: "2026-02-18", changes: [
    "Workout templates system",
    "Cardio tracking (duration, distance, calories, HR)",
    "Auto-generated workout names",
    "Calendar exercise names visible",
  ]},
  { version: "0.05", date: "2026-02-17", changes: [
    "Calendar view with workout dots",
    "Gym check-in & location tracking",
    "Export/share workouts",
    "Shared exercise library",
    "Data loss prevention fix",
  ]},
  { version: "0.04", date: "2026-02-17", changes: [
    "Workout history with expandable detail",
    "Edit & backdate past workouts",
    "Firebase Hosting deploy",
  ]},
  { version: "0.03", date: "2026-02-17", changes: [
    "Firebase auth (Google Sign-In)",
    "Cloud sync across devices",
    "Dark/light theme toggle",
    "Per-set weight tracking",
    "Exercise notes",
  ]},
  { version: "0.02", date: "2026-02-17", changes: [
    "React web app with exercise library",
    "Warmup/working set separation",
    "Progression suggestions & PR tracking",
    "Custom exercise creation",
  ]},
  { version: "0.01", date: "2026-02-16", changes: [
    "Static HTML workout plan from trainer sessions",
  ]},
];

const getInitialData = () => ({ workoutLogs: [], customExercises: [], templates: [], plannedWorkouts: [] });

const formatDate = (d) => new Date(d).toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });

const getLastWorkingWeight = (exerciseId, logs) => {
  for (let i = logs.length - 1; i >= 0; i--) {
    const found = logs[i].exercises.find(e => e.exerciseId === exerciseId);
    if (found && found.workingWeight > 0) return found.workingWeight;
  }
  return 0;
};

const getLastWarmupWeight = (exerciseId, logs) => {
  for (let i = logs.length - 1; i >= 0; i--) {
    const found = logs[i].exercises.find(e => e.exerciseId === exerciseId);
    if (found && found.warmupWeight > 0) return found.warmupWeight;
  }
  return 0;
};

const getLastCardioStats = (exerciseId, logs) => {
  for (let i = logs.length - 1; i >= 0; i--) {
    const found = logs[i].exercises.find(e => e.exerciseId === exerciseId && e.isCardio);
    if (found) return { duration: found.duration || 0, distance: found.distance || 0, calories: found.calories || 0, avgHeartRate: found.avgHeartRate || 0 };
  }
  return null;
};

const getProgressionSuggestion = (exerciseId, logs) => {
  const lastWeight = getLastWorkingWeight(exerciseId, logs);
  if (lastWeight <= 0) return null;
  return Math.round(lastWeight * 1.05 / 5) * 5 || lastWeight + 5;
};

const getPR = (exerciseId, logs) => {
  let max = 0;
  logs.forEach(log => {
    const found = log.exercises.find(e => e.exerciseId === exerciseId);
    if (found) {
      if (found.workingWeight > max) max = found.workingWeight;
      if (found.workingSets) {
        found.workingSets.forEach(s => {
          if (s.weight && s.weight > max && s.completed) max = s.weight;
        });
      }
    }
  });
  return max > 0 ? max : null;
};

// â”€â”€â”€ Icons â”€â”€â”€
const CheckIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
const PlusIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const MinusIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const TrophyIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
const PlayIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
const ChartIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>;
const DumbbellIcon = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.4 14.4 9.6 9.6"/><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767-1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l1.767 1.767a2 2 0 1 1 2.829 2.829Z"/><path d="m21.5 21.5-1.4-1.4"/><path d="M3.9 3.9 2.5 2.5"/><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829Z"/></svg>;
const FlameIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;
const LibraryIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>;
const LinkIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
const EditIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
const TrashIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
const XIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
const SunIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
const MoonIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
const HistoryIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>;
const ChevronIcon = ({down}) => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{transform: down ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s"}}><polyline points="6 9 12 15 18 9"/></svg>;
const ArrowLeftIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>;
const ArrowUpSmall = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>;
const ArrowDownSmall = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>;
const SwapIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>;
const ArrowRightIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 6 15 12 9 18"/></svg>;
const MapPinIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
const CopyIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
const TemplateIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>;
const CalendarIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;

function WorkoutTracker() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState("dashboard");
  const [selectedExercises, setSelectedExercises] = useState([]);
  const [workoutName, setWorkoutName] = useState("");
  const [activeWorkout, setActiveWorkout] = useState(null);
  const [showAddExercise, setShowAddExercise] = useState(false);
  const [newExercise, setNewExercise] = useState({ name: "", category: "posterior", muscle: "", videoUrl: "" });
  const [editingExercise, setEditingExercise] = useState(null);
  const [librarySearch, setLibrarySearch] = useState("");
  const [theme, setTheme] = useState("dark");
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [authError, setAuthError] = useState(null);
  const [expandedLogIdx, setExpandedLogIdx] = useState(null);
  const [calendarMonth, setCalendarMonth] = useState(() => { const d = new Date(); return { year: d.getFullYear(), month: d.getMonth() }; });
  const [calendarSelectedDate, setCalendarSelectedDate] = useState(null);
  const [workoutLocation, setWorkoutLocation] = useState("");
  const [locationSearch, setLocationSearch] = useState("");
  const [nearbyGyms, setNearbyGyms] = useState([]);
  const [locationLoading, setLocationLoading] = useState(false);
  const [locationDetected, setLocationDetected] = useState(false);
  const [editingLogIdx, setEditingLogIdx] = useState(null);
  const [workoutDate, setWorkoutDate] = useState(() => new Date().toISOString().split("T")[0]);
  const [copiedIdx, setCopiedIdx] = useState(null);
  const [sharedExercises, setSharedExercises] = useState([]);
  const [shareToLibrary, setShareToLibrary] = useState(true);
  const [showSaveTemplate, setShowSaveTemplate] = useState(false);
  const [templateName, setTemplateName] = useState("");
  const [buildingTemplate, setBuildingTemplate] = useState(null); // { name, location, exercises: [{exerciseId, targetWeight, targetSets, targetReps}] }
  const [showMidWorkoutPicker, setShowMidWorkoutPicker] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [planningDate, setPlanningDate] = useState(null); // date string for planning a workout
  const [planExerciseConfigs, setPlanExerciseConfigs] = useState([]); // [{exerciseId, targetWeight, warmupWeight, targetSets, targetReps}]
  const [planName, setPlanName] = useState("");
  const [planWarmup, setPlanWarmup] = useState("");
  const [planCooldown, setPlanCooldown] = useState("");
  const [editingPlan, setEditingPlan] = useState(null); // planned workout being edited
  const [editingTemplate, setEditingTemplate] = useState(null); // template being edited
  const [tplName, setTplName] = useState("");
  const [tplExerciseConfigs, setTplExerciseConfigs] = useState([]);
  const [tplWarmup, setTplWarmup] = useState("");
  const [tplCooldown, setTplCooldown] = useState("");
  const [swappingExerciseIdx, setSwappingExerciseIdx] = useState(null); // index of exercise being swapped in active workout

  // Initialize Firebase and listen to auth state
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
      if (firebaseUser) {
        setUser({ uid: firebaseUser.uid, name: firebaseUser.displayName, email: firebaseUser.email, photo: firebaseUser.photoURL });
        const saved = await loadData(firebaseUser.uid);
        setData(saved || getInitialData());
        setDataLoaded(true);
        // Restore active workout draft if exists
        try {
          const draft = await loadActiveWorkoutDraft(firebaseUser.uid);
          if (draft && draft.exercises) {
            setActiveWorkout(draft);
            setView("active");
          }
        } catch (e) { console.error("Draft restore failed:", e); }
        // Load theme preference
        try {
          const prefSnap = await db.collection("users").doc(firebaseUser.uid).collection("data").doc("preferences").get();
          if (prefSnap.exists && prefSnap.data().theme) setTheme(prefSnap.data().theme);
        } catch (e) { console.error("Theme load failed:", e); }
        // Load shared exercises
        try {
          const sharedSnap = await db.collection("shared").doc("exercises").collection("library").get();
          const shared = [];
          sharedSnap.forEach(doc => shared.push({ ...doc.data(), id: doc.id }));
          setSharedExercises(shared);
        } catch (e) { console.error("Shared exercises load failed:", e); }
      } else {
        setUser(null);
        setData(null);
      }
      setAuthLoading(false);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Auto-save active workout draft to Firestore
  useEffect(() => {
    if (!user || !dataLoaded) return;
    const timer = setTimeout(() => {
      saveActiveWorkoutDraft(user.uid, activeWorkout);
    }, 500); // debounce 500ms
    return () => clearTimeout(timer);
  }, [activeWorkout, user, dataLoaded]);

  const handleSignIn = async () => {
    setAuthError(null);
    try {
      await auth.signInWithPopup(googleProvider);
    } catch (e) {
      console.error("Sign in failed:", e);
      if (e.code !== "auth/popup-closed-by-user") {
        setAuthError("Sign in failed. Please try again.");
      }
    }
  };

  const handleSignOut = async () => {
    try {
      await auth.signOut();
      setData(null);
      setDataLoaded(false);
      setActiveWorkout(null);
      setView("dashboard");
    } catch (e) { console.error("Sign out failed:", e); }
  };

  const toggleTheme = () => {

  // Reorder helper
  const moveItem = (arr, from, to) => {
    const updated = [...arr];
    const [item] = updated.splice(from, 1);
    updated.splice(to, 0, item);
    return updated;
  };
    const next = theme === "dark" ? "light" : "dark";
    setTheme(next);
    if (user) {
      db.collection("users").doc(user.uid).collection("data").doc("preferences").set({ theme: next }, { merge: true }).catch(e => console.error("Theme save failed:", e));
    }
  };

  const [dataLoaded, setDataLoaded] = useState(false);

  const persist = useCallback((newData) => {
    setData(newData);
    if (user && dataLoaded) saveData(user.uid, newData);
  }, [user, dataLoaded]);

  if (loading || authLoading) return (
    <div style={{ minHeight: "100vh", background: theme === "dark" ? "#08080d" : "#f5f5f7", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 12 }}>
      <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      <div style={{ color: "#e94560" }}>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.4 14.4 9.6 9.6"/><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767-1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l1.767 1.767a2 2 0 1 1 2.829 2.829Z"/><path d="m21.5 21.5-1.4-1.4"/><path d="M3.9 3.9 2.5 2.5"/><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829Z"/></svg>
      </div>
      <div style={{ color: "#e94560", fontFamily: "'JetBrains Mono', monospace", fontSize: 13, letterSpacing: 3 }}>LOADING...</div>
      <div style={{ color: theme === "dark" ? "#333" : "#999", fontFamily: "'JetBrains Mono', monospace", fontSize: 9, letterSpacing: 1 }}>Connecting to your data</div>
    </div>
  );

  // â”€â”€â”€ Login Screen â”€â”€â”€
  if (!user) {
    const dark = theme === "dark";
    return (
      <div style={{ minHeight: "100vh", background: dark ? "#08080d" : "#f5f5f7", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, fontFamily: "'JetBrains Mono', monospace" }}>
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
        <div style={{ color: "#e94560", marginBottom: 16 }}>
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.4 14.4 9.6 9.6"/><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767-1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l1.767 1.767a2 2 0 1 1 2.829 2.829Z"/><path d="m21.5 21.5-1.4-1.4"/><path d="M3.9 3.9 2.5 2.5"/><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829Z"/></svg>
        </div>
        <div style={{ fontSize: 22, fontWeight: 800, color: dark ? "#fff" : "#111", letterSpacing: "-0.5px", marginBottom: 4 }}>WORKOUT TRACKER</div>
        <div style={{ fontSize: 10, color: dark ? "#444" : "#999", letterSpacing: 2, textTransform: "uppercase", marginBottom: 32 }}>GetNerdyIn30.com</div>
        <div style={{ fontSize: 12, color: dark ? "#888" : "#666", textAlign: "center", marginBottom: 24, maxWidth: 300, lineHeight: 1.6 }}>
          Track your workouts, log your sets, and watch your PRs climb. Sign in to sync across all your devices.
        </div>
        <button onClick={handleSignIn} style={{
          background: dark ? "#fff" : "#111",
          color: dark ? "#111" : "#fff",
          border: "none", borderRadius: 10, padding: "14px 28px",
          fontSize: 13, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace",
          cursor: "pointer", letterSpacing: 0.5,
          display: "flex", alignItems: "center", gap: 10,
          transition: "opacity 0.2s",
        }}>
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          SIGN IN WITH GOOGLE
        </button>
        {authError && <div style={{ marginTop: 16, fontSize: 11, color: "#e94560" }}>{authError}</div>}
        <button onClick={toggleTheme} style={{ marginTop: 24, background: "none", border: `1px solid ${dark ? "#22223a" : "#d0d0da"}`, borderRadius: 8, padding: "6px 12px", cursor: "pointer", color: dark ? "#444" : "#999", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", display: "flex", alignItems: "center", gap: 6 }}>
          {dark ? "â˜€ LIGHT MODE" : "ðŸŒ™ DARK MODE"}
        </button>
      </div>
    );
  }

  const allExercises = [...DEFAULT_EXERCISES, ...sharedExercises, ...(data.customExercises || [])];

  const startWorkout = () => {
    if (activeWorkout && activeWorkout.exercises) {
      if (!confirm("You have a workout in progress (" + activeWorkout.name + "). Starting a new one will replace it. Continue?")) return;
    }
    const exercises = selectedExercises.map(id => {
      const ex = allExercises.find(e => e.id === id);
      const isCardio = ex.isCardio || ex.category === "cardio";

      if (isCardio) {
        // Get last cardio stats for this exercise
        const lastCardio = getLastCardioStats(id, data.workoutLogs);
        return {
          exerciseId: id,
          name: ex.name,
          category: ex.category,
          isCardio: true,
          duration: lastCardio?.duration || 0,
          distance: lastCardio?.distance || 0,
          calories: lastCardio?.calories || 0,
          avgHeartRate: lastCardio?.avgHeartRate || 0,
          notes: "",
          completed: false,
        };
      }

      const lastWorking = getLastWorkingWeight(id, data.workoutLogs);
      const lastWarmup = getLastWarmupWeight(id, data.workoutLogs);
      const suggestion = getProgressionSuggestion(id, data.workoutLogs);
      const pr = getPR(id, data.workoutLogs);
      return {
        exerciseId: id,
        name: ex.name,
        category: ex.category,
        warmupWeight: lastWarmup || (lastWorking > 0 ? Math.round(lastWorking * 0.5 / 5) * 5 : 0),
        workingWeight: lastWorking || 0,
        warmupSets: [{ reps: 0, completed: false }],
        workingSets: [
          { reps: 0, completed: false, weight: null },
          { reps: 0, completed: false, weight: null },
          { reps: 0, completed: false, weight: null },
        ],
        notes: "",
        pr,
        suggestion,
        lastWorking,
      };
    });
    const selectedDate = new Date(workoutDate + "T12:00:00");
    // Auto-generate name from exercise categories if user didn't set one
    let autoName = workoutName;
    if (!autoName) {
      const cats = [...new Set(exercises.map(e => e.category))];
      const catLabels = cats.map(c => (CATEGORY_COLORS[c] || {}).label || c).filter(Boolean);
      autoName = catLabels.length > 0 ? catLabels.join(" + ") : "Workout";
    }
    setActiveWorkout({ date: selectedDate.toISOString(), name: autoName, location: workoutLocation || "", exercises });
    setView("active");
  };

  const saveWorkout = () => {
    if (editingLogIdx !== null) {
      // Editing existing workout â€” replace it in place
      const updatedLogs = [...data.workoutLogs];
      updatedLogs[editingLogIdx] = activeWorkout;
      persist({ ...data, workoutLogs: updatedLogs });
      setEditingLogIdx(null);
    } else {
      // New workout
      persist({ ...data, workoutLogs: [...data.workoutLogs, activeWorkout] });
    }
    setActiveWorkout(null);
    setSelectedExercises([]);
    setWorkoutName("");
    setWorkoutLocation("");
    setWorkoutDate(new Date().toISOString().split("T")[0]);
    setNearbyGyms([]);
    setLocationDetected(false);
    setView("dashboard");
  };

  const clearAllData = () => {
    persist(getInitialData());
    setActiveWorkout(null);
    setSelectedExercises([]);
    setView("dashboard");
  };

  // â”€â”€â”€ Location helpers â”€â”€â”€
  const getRecentGyms = () => {
    const gyms = [];
    const seen = new Set();
    for (let i = (data.workoutLogs || []).length - 1; i >= 0; i--) {
      const loc = data.workoutLogs[i].location;
      if (loc && !seen.has(loc)) {
        seen.add(loc);
        gyms.push(loc);
      }
      if (gyms.length >= 5) break;
    }
    return gyms;
  };

  const detectLocation = () => {
    if (!navigator.geolocation) return;
    setLocationLoading(true);
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        try {
          const { latitude, longitude } = pos.coords;
          // Use Nominatim (free, no API key) to reverse geocode nearby places
          const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&zoom=18`);
          const data = await resp.json();

          // Also search for nearby gyms/fitness
          const searchResp = await fetch(`https://nominatim.openstreetmap.org/search?q=gym+fitness&format=json&limit=5&viewbox=${longitude-0.02},${latitude+0.02},${longitude+0.02},${latitude-0.02}&bounded=1`);
          const nearby = await searchResp.json();

          const gymNames = nearby.map(p => p.display_name.split(",")[0].trim()).filter(n => n.length > 0);
          setNearbyGyms(gymNames);
          setLocationDetected(true);
        } catch (e) {
          console.error("Location lookup failed:", e);
        }
        setLocationLoading(false);
      },
      (err) => {
        console.error("Geolocation error:", err);
        setLocationLoading(false);
      },
      { timeout: 10000 }
    );
  };

  // â”€â”€â”€ Theme tokens â”€â”€â”€
  const dark = theme === "dark";
  const T = {
    bg: dark ? "#08080d" : "#f5f5f7",
    bgCard: dark ? "#0e0e16" : "#ffffff",
    bgInset: dark ? "#0c0c12" : "#f0f0f4",
    bgNav: dark ? "#0a0a10" : "#ffffff",
    border: dark ? "#18182a" : "#e2e2ea",
    borderSubtle: dark ? "#14141f" : "#ececf0",
    borderInput: dark ? "#22223a" : "#d0d0da",
    text: dark ? "#c0c0cc" : "#333340",
    textStrong: dark ? "#fff" : "#111118",
    textMuted: dark ? "#444" : "#666",
    textFaint: dark ? "#333" : "#888",
    inputBg: dark ? "#08080d" : "#f5f5f7",
    inputText: dark ? "#fff" : "#111118",
    navInactive: dark ? "#333" : "#aaa",
    warmupBg: dark ? "#0c0c12" : "#fffbf0",
    completedSetBg: (isWarmup) => dark
      ? (isWarmup ? "#f59e0b12" : "#22c55e12")
      : (isWarmup ? "#f59e0b15" : "#22c55e15"),
    uncompletedSetBg: dark ? "#08080d" : "#f5f5f7",
  };

  // â”€â”€â”€ Styles â”€â”€â”€
  const S = {
    app: { minHeight: "100vh", background: T.bg, fontFamily: "'JetBrains Mono', 'Fira Code', monospace", color: T.text, maxWidth: 520, margin: "0 auto", padding: "0 16px 100px", transition: "background 0.3s, color 0.3s" },
    header: { padding: "24px 0 16px", borderBottom: `1px solid ${T.borderSubtle}`, marginBottom: 20 },
    title: { fontSize: 19, fontWeight: 800, color: T.textStrong, letterSpacing: "-0.5px" },
    subtitle: { fontSize: 10, color: T.textMuted, letterSpacing: 2, textTransform: "uppercase", marginTop: 2 },
    card: { background: T.bgCard, borderRadius: 10, padding: 16, marginBottom: 10, border: `1px solid ${T.border}`, transition: "background 0.3s, border-color 0.3s" },
    btn: (color = "#e94560") => ({ background: color, color: "#fff", border: "none", borderRadius: 8, padding: "13px 20px", fontSize: 12, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", cursor: "pointer", letterSpacing: 1, width: "100%", transition: "opacity 0.2s" }),
    btnOutline: (color = "#e94560") => ({ background: "none", color, border: `1px solid ${color}`, borderRadius: 8, padding: "10px 16px", fontSize: 11, fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", cursor: "pointer", letterSpacing: 0.5, width: "100%" }),
    tag: (color) => ({ display: "inline-block", padding: "2px 8px", borderRadius: 4, fontSize: 8, fontWeight: 700, letterSpacing: 1.5, textTransform: "uppercase", color, background: color + (dark ? "15" : "18"), marginRight: 6 }),
    input: { background: T.inputBg, border: `1px solid ${T.borderInput}`, borderRadius: 6, color: T.inputText, padding: "8px 12px", fontSize: 14, fontFamily: "'JetBrains Mono', monospace", width: "100%", outline: "none", transition: "background 0.3s, border-color 0.3s, color 0.3s" },
    sectionLabel: { fontSize: 9, letterSpacing: 2, textTransform: "uppercase", marginBottom: 8, display: "flex", alignItems: "center", gap: 6 },
    setBtn: (completed, isWarmup) => ({
      width: 42, height: 42, borderRadius: 8,
      border: completed ? `2px solid ${isWarmup ? "#f59e0b" : "#22c55e"}` : `2px solid ${T.borderInput}`,
      background: completed ? T.completedSetBg(isWarmup) : T.uncompletedSetBg,
      color: completed ? (isWarmup ? "#f59e0b" : "#22c55e") : T.textMuted,
      display: "flex", alignItems: "center", justifyContent: "center",
      cursor: "pointer", fontSize: 13, fontWeight: 700,
      fontFamily: "'JetBrains Mono', monospace", transition: "all 0.15s",
    }),
    nav: { position: "fixed", bottom: 0, left: 0, right: 0, background: dark ? "#111118" : "#ffffff", borderTop: `2px solid ${dark ? "#e9456033" : "#e9456022"}`, display: "flex", justifyContent: "center", zIndex: 100, padding: "6px 8px 8px", gap: 6, transition: "background 0.3s, border-color 0.3s" },
    navBtn: (active) => ({ flex: 1, maxWidth: 110, padding: "10px 0 8px", background: active ? (dark ? "#e9456020" : "#e9456012") : "transparent", border: active ? "1px solid #e9456044" : "1px solid transparent", borderRadius: 10, color: active ? "#e94560" : (dark ? "#555" : "#aaa"), fontSize: 9, fontWeight: active ? 700 : 500, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, cursor: "pointer", display: "flex", flexDirection: "column", alignItems: "center", gap: 4, transition: "all 0.2s" }),
    themeToggle: { background: "none", border: `1px solid ${T.borderInput}`, borderRadius: 8, padding: "6px 8px", cursor: "pointer", color: T.textMuted, display: "flex", alignItems: "center", justifyContent: "center", transition: "all 0.2s" },
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DASHBOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderDashboard = () => {
    const totalWorkouts = data.workoutLogs.length;
    const totalSets = data.workoutLogs.reduce((sum, log) =>
      sum + log.exercises.reduce((s, ex) => (ex.warmupSets || []).filter(s => s.completed).length + (ex.workingSets || ex.sets || []).filter(s => s.completed).length, 0), 0);
    const prCount = allExercises.filter(ex => getPR(ex.id, data.workoutLogs)).length;

    return (
      <div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, marginBottom: 16 }}>
          {[
            { label: "WORKOUTS", value: totalWorkouts, color: "#e94560" },
            { label: "SETS", value: totalSets, color: "#f59e0b" },
            { label: "PRs", value: prCount, color: "#22c55e" },
          ].map(stat => (
            <div key={stat.label} style={{ ...S.card, textAlign: "center", padding: 14 }}>
              <div style={{ fontSize: 22, fontWeight: 800, color: stat.color }}>{stat.value}</div>
              <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 2, marginTop: 2 }}>{stat.label}</div>
            </div>
          ))}
        </div>

        <button style={S.btn()} onClick={() => setView("build")}>
          <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><PlusIcon /> START NEW WORKOUT</span>
        </button>

        <button style={{ ...S.btnOutline("#f59e0b"), marginTop: 8 }} onClick={() => {
          setBuildingTemplate({ name: "", location: "", exercises: [] });
          setView("buildTemplate");
        }}>
          <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><TemplateIcon /> CREATE TEMPLATE</span>
        </button>

        {/* Upcoming Planned Workouts */}
        {(() => {
          const now = new Date();
          const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
          const upcoming = (data.plannedWorkouts || [])
            .filter(p => p.date >= today)
            .sort((a, b) => a.date.localeCompare(b.date));
          if (upcoming.length === 0) return null;
          return (
            <div style={{ marginTop: 14 }}>
              <div style={{ fontSize: 8, color: "#0ea5e9", letterSpacing: 1.5, marginBottom: 6 }}>UPCOMING PLANNED WORKOUTS</div>
              <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                {upcoming.map(plan => {
                  const planDate = new Date(plan.date + "T12:00:00");
                  const dayLabel = planDate.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
                  const isToday = plan.date === today;
                  return (
                    <div key={plan.id} style={{ display: "flex", gap: 6 }}>
                      <button onClick={() => openPlanEditor(plan)}
                        style={{ ...S.card, flex: 1, padding: "12px 14px", cursor: "pointer", textAlign: "left", display: "flex", alignItems: "center", gap: 10, border: `1px solid ${isToday ? "#0ea5e944" : "#0ea5e922"}`, background: isToday ? (dark ? "#0ea5e908" : "#0ea5e906") : T.bgCard }}>
                        <span style={{ color: "#0ea5e9" }}><CalendarIcon /></span>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.textStrong }}>{plan.name}</div>
                            {isToday && <span style={{ fontSize: 7, color: "#0ea5e9", background: "#0ea5e915", padding: "1px 6px", borderRadius: 3, fontWeight: 700, letterSpacing: 0.5 }}>TODAY</span>}
                          </div>
                          <div style={{ fontSize: 9, color: T.textMuted, marginTop: 1 }}>
                            {dayLabel} Â· {plan.exerciseIds.length} exercises
                          </div>
                          <div style={{ fontSize: 9, color: T.textFaint, marginTop: 2 }}>
                            {plan.exerciseIds.map(id => allExercises.find(e => e.id === id)?.name).filter(Boolean).join(" Â· ")}
                          </div>
                        </div>
                      </button>
                      <button onClick={() => duplicatePlannedWorkout(plan)}
                        style={{ background: "none", border: `1px solid #0ea5e915`, borderRadius: 10, color: "#0ea5e9", cursor: "pointer", padding: "0 10px", display: "flex", alignItems: "center", opacity: 0.5 }}>
                        <CopyIcon />
                      </button>
                      <button onClick={() => { if (confirm("Delete planned workout \"" + plan.name + "\"?")) deletePlannedWorkout(plan.id); }}
                        style={{ background: "none", border: `1px solid #e9456015`, borderRadius: 10, color: "#e94560", cursor: "pointer", padding: "0 10px", display: "flex", alignItems: "center", opacity: 0.5 }}>
                        <TrashIcon />
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })()}

        {/* â”€â”€ PLAN EDITOR â”€â”€ */}
        {editingPlan && planningDate && (
          <div style={{ ...S.card, padding: 0, marginTop: 14, borderColor: "#0ea5e933" }}>
            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1 }}>EDIT PLAN â€” {new Date(editingPlan.date + "T12:00:00").toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" })}</span>
              <button onClick={() => { setEditingPlan(null); setPlanningDate(null); setPlanExerciseConfigs([]); setPlanName(""); setPlanWarmup(""); setPlanCooldown(""); }}
                style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><XIcon /></button>
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>WORKOUT NAME</div>
              <input style={{ ...S.input, fontSize: 12 }} placeholder="Auto-generates from exercises" value={planName} onChange={e => setPlanName(e.target.value)} />
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
              <div style={{ fontSize: 9, color: "#f59e0b", letterSpacing: 1, marginBottom: 4 }}>WARMUP</div>
              <textarea style={{ ...S.input, fontSize: 11, minHeight: 36, resize: "vertical", lineHeight: 1.5, padding: "8px 10px", borderColor: "#f59e0b15" }}
                placeholder="e.g. Leg swings, TRX squat & row..."
                value={planWarmup} onChange={e => setPlanWarmup(e.target.value)} />
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
              <div style={{ fontSize: 9, color: "#8b5cf6", letterSpacing: 1, marginBottom: 4 }}>COOLDOWN</div>
              <textarea style={{ ...S.input, fontSize: 11, minHeight: 36, resize: "vertical", lineHeight: 1.5, padding: "8px 10px", borderColor: "#8b5cf615" }}
                placeholder="e.g. Tabata finisher, stretching..."
                value={planCooldown} onChange={e => setPlanCooldown(e.target.value)} />
            </div>

            <div style={{ maxHeight: 350, overflowY: "auto", padding: "8px 0" }}>
              {(() => {
                const categories = [...new Set(allExercises.map(e => e.category))];
                return categories.map(cat => {
                  const catExercises = allExercises.filter(e => e.category === cat);
                  const catInfo = CATEGORY_COLORS[cat] || { accent: "#888", label: cat };
                  return (
                    <div key={cat} style={{ padding: "0 12px" }}>
                      <div style={{ ...S.tag(catInfo.accent), marginTop: 8, marginBottom: 4 }}>{catInfo.label}</div>
                      {catExercises.map(ex => {
                        const config = planExerciseConfigs.find(c => c.exerciseId === ex.id);
                        const selected = !!config;
                        const isCardio = ex.isCardio || ex.category === "cardio";
                        const lastWeight = isCardio ? null : getLastWorkingWeight(ex.id, data.workoutLogs);
                        const lastWarmup = isCardio ? null : getLastWarmupWeight(ex.id, data.workoutLogs);
                        const suggestion = isCardio ? null : getProgressionSuggestion(ex.id, data.workoutLogs);

                        const toggleExercise = (e) => {
                          e.stopPropagation();
                          if (selected) {
                            setPlanExerciseConfigs(prev => prev.filter(c => c.exerciseId !== ex.id));
                          } else {
                            setPlanExerciseConfigs(prev => [...prev, {
                              exerciseId: ex.id,
                              targetWeight: lastWeight || 0,
                              warmupWeight: lastWarmup || (lastWeight > 0 ? Math.round(lastWeight * 0.5 / 5) * 5 : 0),
                              targetSets: 3,
                              targetReps: 12,
                            }]);
                          }
                        };

                        const updateConfig = (field, value) => {
                          setPlanExerciseConfigs(prev => prev.map(c =>
                            c.exerciseId === ex.id ? { ...c, [field]: value } : c
                          ));
                        };

                        return (
                          <div key={ex.id} style={{ borderRadius: 6, marginBottom: 2, background: selected ? (dark ? "#0ea5e908" : "#0ea5e906") : "transparent" }}>
                            <div onClick={toggleExercise}
                              style={{ padding: "8px 12px", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                              <div>
                                <div style={{ fontSize: 12, fontWeight: 600, color: selected ? T.textStrong : T.textMuted }}>{ex.name}</div>
                                <div style={{ fontSize: 9, color: T.textFaint, marginTop: 1 }}>
                                  {ex.muscle}
                                  {!isCardio && lastWeight > 0 && <span style={{ color: T.textMuted }}> Â· Last: {lastWeight} lb</span>}
                                  {!isCardio && suggestion && <span style={{ color: "#22c55e" }}> Â· Suggested: {suggestion} lb</span>}
                                </div>
                              </div>
                              <div style={{ width: 20, height: 20, borderRadius: 5, border: `2px solid ${selected ? "#0ea5e9" : T.borderInput}`, background: selected ? "#0ea5e920" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#0ea5e9", flexShrink: 0 }}>
                                {selected && <CheckIcon />}
                              </div>
                            </div>

                            {selected && !isCardio && (
                              <div style={{ padding: "4px 12px 12px", display: "flex", gap: 8, flexWrap: "wrap" }}
                                onClick={e => e.stopPropagation()}>
                                <div style={{ flex: 1, minWidth: 70 }}>
                                  <div style={{ fontSize: 7, color: "#f59e0b", letterSpacing: 0.5, marginBottom: 2 }}>WARMUP</div>
                                  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                    <input type="number" value={config.warmupWeight || ""} placeholder="0"
                                      onChange={e => updateConfig("warmupWeight", Number(e.target.value) || 0)}
                                      style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#f59e0b25" }} />
                                    <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                  </div>
                                </div>
                                <div style={{ flex: 1, minWidth: 70 }}>
                                  <div style={{ fontSize: 7, color: "#22c55e", letterSpacing: 0.5, marginBottom: 2 }}>WORKING</div>
                                  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                    <input type="number" value={config.targetWeight || ""} placeholder="0"
                                      onChange={e => updateConfig("targetWeight", Number(e.target.value) || 0)}
                                      style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#22c55e25" }} />
                                    <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                  </div>
                                </div>
                                <div style={{ flex: 0.6, minWidth: 50 }}>
                                  <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>SETS</div>
                                  <input type="number" value={config.targetSets || ""} placeholder="3"
                                    onChange={e => updateConfig("targetSets", Number(e.target.value) || 0)}
                                    style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                </div>
                                <div style={{ flex: 0.6, minWidth: 50 }}>
                                  <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>REPS</div>
                                  <input type="number" value={config.targetReps || ""} placeholder="12"
                                    onChange={e => updateConfig("targetReps", Number(e.target.value) || 0)}
                                    style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  );
                });
              })()}
            </div>

            {planExerciseConfigs.length > 1 && (
              <div style={{ padding: "10px 16px", borderTop: `1px solid ${T.borderSubtle}` }}>
                <div style={{ fontSize: 8, color: "#0ea5e9", letterSpacing: 1.5, marginBottom: 6 }}>EXERCISE ORDER</div>
                {planExerciseConfigs.map((cfg, idx) => {
                  const ex = allExercises.find(e => e.id === cfg.exerciseId);
                  return (
                    <div key={cfg.exerciseId} style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 0", borderBottom: idx < planExerciseConfigs.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                      <span style={{ fontSize: 9, color: T.textFaint, width: 16, textAlign: "center", fontWeight: 700 }}>{idx + 1}</span>
                      <span style={{ flex: 1, fontSize: 11, color: T.textStrong, fontWeight: 600 }}>{ex?.name || "Unknown"}</span>
                      <button onClick={() => idx > 0 && setPlanExerciseConfigs(moveItem(planExerciseConfigs, idx, idx - 1))}
                        style={{ background: "none", border: "none", color: idx > 0 ? "#0ea5e9" : T.borderInput, cursor: idx > 0 ? "pointer" : "default", padding: 4 }}>
                        <ArrowUpSmall />
                      </button>
                      <button onClick={() => idx < planExerciseConfigs.length - 1 && setPlanExerciseConfigs(moveItem(planExerciseConfigs, idx, idx + 1))}
                        style={{ background: "none", border: "none", color: idx < planExerciseConfigs.length - 1 ? "#0ea5e9" : T.borderInput, cursor: idx < planExerciseConfigs.length - 1 ? "pointer" : "default", padding: 4 }}>
                        <ArrowDownSmall />
                      </button>
                    </div>
                  );
                })}
              </div>
            )}

            {planExerciseConfigs.length > 0 && (
              <div style={{ padding: "12px 16px", borderTop: `1px solid ${T.borderSubtle}`, display: "flex", gap: 8 }}>
                <button onClick={updatePlannedWorkout}
                  style={{ ...S.btn("#0ea5e9"), flex: 1, padding: "12px 16px" }}>
                  <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>SAVE CHANGES</span>
                </button>
                <button onClick={() => {
                  updatePlannedWorkout();
                  const updated = { ...editingPlan, name: planName || editingPlan.name, exerciseIds: planExerciseConfigs.map(c => c.exerciseId), exerciseConfigs: planExerciseConfigs, warmupNotes: planWarmup, cooldownNotes: planCooldown };
                  setWorkoutDate(updated.date);
                  startPlannedWorkout(updated);
                }}
                  style={{ ...S.btn("#22c55e"), flex: 1, padding: "12px 16px" }}>
                  <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><PlayIcon /> START</span>
                </button>
              </div>
            )}
          </div>
        )}

        {/* Templates - Recurring Routines */}
        {(data.templates || []).length > 0 && (
          <div style={{ marginTop: 14 }}>
            <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1.5, marginBottom: 6 }}>TEMPLATES</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
              {(data.templates || []).map(tpl => (
                <div key={tpl.id} style={{ display: "flex", gap: 6 }}>
                  <button onClick={() => openTemplateEditor(tpl)}
                    style={{ ...S.card, flex: 1, padding: "12px 14px", cursor: "pointer", textAlign: "left", display: "flex", alignItems: "center", gap: 10, border: `1px solid ${dark ? "#f59e0b22" : "#f59e0b33"}` }}>
                    <span style={{ color: "#f59e0b" }}><TemplateIcon /></span>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: T.textStrong }}>{tpl.name}</div>
                      <div style={{ fontSize: 9, color: T.textMuted, marginTop: 1 }}>
                        {tpl.exerciseIds.length} exercises{tpl.location ? ` Â· ${tpl.location}` : ""}
                      </div>
                    </div>
                  </button>
                  <button onClick={() => { if (confirm("Delete template \"" + tpl.name + "\"?")) deleteTemplate(tpl.id); }}
                    style={{ background: "none", border: `1px solid #e9456015`, borderRadius: 10, color: "#e94560", cursor: "pointer", padding: "0 10px", display: "flex", alignItems: "center", opacity: 0.5 }}>
                    <TrashIcon />
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* â”€â”€ TEMPLATE EDITOR â”€â”€ */}
        {editingTemplate && (
          <div style={{ ...S.card, padding: 0, marginTop: 14, borderColor: "#f59e0b33" }}>
            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 11, fontWeight: 700, color: "#f59e0b", letterSpacing: 1 }}>EDIT TEMPLATE</span>
              <button onClick={() => { setEditingTemplate(null); setTplName(""); setTplExerciseConfigs([]); }}
                style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><XIcon /></button>
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>TEMPLATE NAME</div>
              <input style={{ ...S.input, fontSize: 12 }} placeholder="Auto-generates from exercises" value={tplName} onChange={e => setTplName(e.target.value)} />
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", gap: 8 }}>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 9, color: "#f59e0b", letterSpacing: 1, marginBottom: 4 }}>WARMUP NOTES</div>
                <textarea value={tplWarmup} onChange={e => setTplWarmup(e.target.value)}
                  placeholder="e.g. Leg swings, TRX squats..."
                  style={{ ...S.input, fontSize: 10, minHeight: 40, resize: "vertical" }} />
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 9, color: "#8b5cf6", letterSpacing: 1, marginBottom: 4 }}>COOLDOWN NOTES</div>
                <textarea value={tplCooldown} onChange={e => setTplCooldown(e.target.value)}
                  placeholder="e.g. Stretching, foam roll..."
                  style={{ ...S.input, fontSize: 10, minHeight: 40, resize: "vertical" }} />
              </div>
            </div>

            <div style={{ maxHeight: 350, overflowY: "auto", padding: "8px 0" }}>
              {(() => {
                const categories = [...new Set(allExercises.map(e => e.category))];
                return categories.map(cat => {
                  const catExercises = allExercises.filter(e => e.category === cat);
                  const catInfo = CATEGORY_COLORS[cat] || { accent: "#888", label: cat };
                  return (
                    <div key={cat} style={{ padding: "0 12px" }}>
                      <div style={{ ...S.tag(catInfo.accent), marginTop: 8, marginBottom: 4 }}>{catInfo.label}</div>
                      {catExercises.map(ex => {
                        const config = tplExerciseConfigs.find(c => c.exerciseId === ex.id);
                        const selected = !!config;
                        const isCardio = ex.isCardio || ex.category === "cardio";
                        const lastWeight = isCardio ? null : getLastWorkingWeight(ex.id, data.workoutLogs);
                        const lastWarmup = isCardio ? null : getLastWarmupWeight(ex.id, data.workoutLogs);
                        const suggestion = isCardio ? null : getProgressionSuggestion(ex.id, data.workoutLogs);

                        const toggleExercise = (e) => {
                          e.stopPropagation();
                          if (selected) {
                            setTplExerciseConfigs(prev => prev.filter(c => c.exerciseId !== ex.id));
                          } else {
                            setTplExerciseConfigs(prev => [...prev, {
                              exerciseId: ex.id,
                              targetWeight: lastWeight || 0,
                              warmupWeight: lastWarmup || (lastWeight > 0 ? Math.round(lastWeight * 0.5 / 5) * 5 : 0),
                              targetSets: 3,
                              targetReps: 12,
                            }]);
                          }
                        };

                        const updateConfig = (field, value) => {
                          setTplExerciseConfigs(prev => prev.map(c =>
                            c.exerciseId === ex.id ? { ...c, [field]: value } : c
                          ));
                        };

                        return (
                          <div key={ex.id} style={{ borderRadius: 6, marginBottom: 2, background: selected ? (dark ? "#f59e0b08" : "#f59e0b06") : "transparent" }}>
                            <div onClick={toggleExercise}
                              style={{ padding: "8px 12px", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                              <div>
                                <div style={{ fontSize: 12, fontWeight: 600, color: selected ? T.textStrong : T.textMuted }}>{ex.name}</div>
                                <div style={{ fontSize: 9, color: T.textFaint, marginTop: 1 }}>
                                  {ex.muscle}
                                  {!isCardio && lastWeight > 0 && <span style={{ color: T.textMuted }}> Â· Last: {lastWeight} lb</span>}
                                  {!isCardio && suggestion && <span style={{ color: "#22c55e" }}> Â· Suggested: {suggestion} lb</span>}
                                </div>
                              </div>
                              <div style={{ width: 20, height: 20, borderRadius: 5, border: `2px solid ${selected ? "#f59e0b" : T.borderInput}`, background: selected ? "#f59e0b20" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#f59e0b", flexShrink: 0 }}>
                                {selected && <CheckIcon />}
                              </div>
                            </div>

                            {selected && !isCardio && (
                              <div style={{ padding: "4px 12px 12px", display: "flex", gap: 8, flexWrap: "wrap" }}
                                onClick={e => e.stopPropagation()}>
                                <div style={{ flex: 1, minWidth: 70 }}>
                                  <div style={{ fontSize: 7, color: "#f59e0b", letterSpacing: 0.5, marginBottom: 2 }}>WARMUP</div>
                                  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                    <input type="number" value={config.warmupWeight || ""} placeholder="0"
                                      onChange={e => updateConfig("warmupWeight", Number(e.target.value) || 0)}
                                      style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#f59e0b25" }} />
                                    <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                  </div>
                                </div>
                                <div style={{ flex: 1, minWidth: 70 }}>
                                  <div style={{ fontSize: 7, color: "#22c55e", letterSpacing: 0.5, marginBottom: 2 }}>WORKING</div>
                                  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                    <input type="number" value={config.targetWeight || ""} placeholder="0"
                                      onChange={e => updateConfig("targetWeight", Number(e.target.value) || 0)}
                                      style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#22c55e25" }} />
                                    <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                  </div>
                                </div>
                                <div style={{ flex: 0.6, minWidth: 50 }}>
                                  <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>SETS</div>
                                  <input type="number" value={config.targetSets || ""} placeholder="3"
                                    onChange={e => updateConfig("targetSets", Number(e.target.value) || 0)}
                                    style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                </div>
                                <div style={{ flex: 0.6, minWidth: 50 }}>
                                  <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>REPS</div>
                                  <input type="number" value={config.targetReps || ""} placeholder="12"
                                    onChange={e => updateConfig("targetReps", Number(e.target.value) || 0)}
                                    style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  );
                });
              })()}
            </div>

            {tplExerciseConfigs.length > 1 && (
              <div style={{ padding: "10px 16px", borderTop: `1px solid ${T.borderSubtle}` }}>
                <div style={{ fontSize: 8, color: "#f59e0b", letterSpacing: 1.5, marginBottom: 6 }}>EXERCISE ORDER</div>
                {tplExerciseConfigs.map((cfg, idx) => {
                  const ex = allExercises.find(e => e.id === cfg.exerciseId);
                  return (
                    <div key={cfg.exerciseId} style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 0", borderBottom: idx < tplExerciseConfigs.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                      <span style={{ fontSize: 9, color: T.textFaint, width: 16, textAlign: "center", fontWeight: 700 }}>{idx + 1}</span>
                      <span style={{ flex: 1, fontSize: 11, color: T.textStrong, fontWeight: 600 }}>{ex?.name || "Unknown"}</span>
                      <button onClick={() => idx > 0 && setTplExerciseConfigs(moveItem(tplExerciseConfigs, idx, idx - 1))}
                        style={{ background: "none", border: "none", color: idx > 0 ? "#f59e0b" : T.borderInput, cursor: idx > 0 ? "pointer" : "default", padding: 4 }}>
                        <ArrowUpSmall />
                      </button>
                      <button onClick={() => idx < tplExerciseConfigs.length - 1 && setTplExerciseConfigs(moveItem(tplExerciseConfigs, idx, idx + 1))}
                        style={{ background: "none", border: "none", color: idx < tplExerciseConfigs.length - 1 ? "#f59e0b" : T.borderInput, cursor: idx < tplExerciseConfigs.length - 1 ? "pointer" : "default", padding: 4 }}>
                        <ArrowDownSmall />
                      </button>
                    </div>
                  );
                })}
              </div>
            )}

            {tplExerciseConfigs.length > 0 && (
              <div style={{ padding: "12px 16px", borderTop: `1px solid ${T.borderSubtle}`, display: "flex", gap: 8 }}>
                <button onClick={updateTemplate}
                  style={{ ...S.btn("#f59e0b"), flex: 1, padding: "12px 16px" }}>
                  <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>SAVE CHANGES</span>
                </button>
                <button onClick={() => {
                  updateTemplate();
                  const updated = { ...editingTemplate, name: tplName || editingTemplate.name, exerciseIds: tplExerciseConfigs.map(c => c.exerciseId), exerciseConfigs: tplExerciseConfigs };
                  startFromTemplate(updated);
                }}
                  style={{ ...S.btn("#22c55e"), flex: 1, padding: "12px 16px" }}>
                  <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><PlayIcon /> START</span>
                </button>
              </div>
            )}
          </div>
        )}

        {(() => {
          const { year, month } = calendarMonth;
          const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          const dayNames = ["Su","Mo","Tu","We","Th","Fr","Sa"];
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const today = new Date();

          // Build map of date strings to workout logs
          const workoutsByDate = {};
          data.workoutLogs.forEach((log, idx) => {
            const d = new Date(log.date);
            const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            if (!workoutsByDate[key]) workoutsByDate[key] = [];
            workoutsByDate[key].push({ ...log, _idx: idx });
          });

          const plannedByDate = {};
          (data.plannedWorkouts || []).forEach(p => {
            const d = new Date(p.date + "T12:00:00");
            const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            if (!plannedByDate[key]) plannedByDate[key] = [];
            plannedByDate[key].push(p);
          });

          const prevMonth = () => setCalendarMonth(m => m.month === 0 ? { year: m.year - 1, month: 11 } : { ...m, month: m.month - 1 });
          const nextMonth = () => {
            setCalendarMonth(m => m.month === 11 ? { year: m.year + 1, month: 0 } : { ...m, month: m.month + 1 });
          };

          const selectedKey = calendarSelectedDate;
          const selectedLogs = selectedKey ? (workoutsByDate[selectedKey] || []) : [];
          const selectedPlans = selectedKey ? (plannedByDate[selectedKey] || []) : [];

          return (
            <div style={{ marginTop: 24 }}>
              {/* Calendar header */}
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                <button onClick={prevMonth} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><ArrowLeftIcon /></button>
                <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong, letterSpacing: 0.5 }}>{monthNames[month]} {year}</div>
                <button onClick={nextMonth} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><ArrowRightIcon /></button>
              </div>

              {/* Day names */}
              <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 2, marginBottom: 4 }}>
                {dayNames.map(d => (
                  <div key={d} style={{ textAlign: "center", fontSize: 8, color: T.textFaint, letterSpacing: 1, fontWeight: 600, padding: "4px 0" }}>{d}</div>
                ))}
              </div>

              {/* Calendar grid */}
              <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 2 }}>
                {Array.from({ length: firstDay }).map((_, i) => <div key={`empty-${i}`} />)}
                {Array.from({ length: daysInMonth }).map((_, i) => {
                  const day = i + 1;
                  const key = `${year}-${month}-${day}`;
                  const hasWorkout = !!workoutsByDate[key];
                  const hasPlanned = !!plannedByDate[key];
                  const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                  const isSelected = selectedKey === key;
                  const workoutCount = hasWorkout ? workoutsByDate[key].length : 0;

                  return (
                    <div key={day} onClick={() => setCalendarSelectedDate(isSelected ? null : key)}
                      style={{
                        textAlign: "center", padding: "6px 0", borderRadius: 8, cursor: "pointer",
                        background: isSelected ? "#e9456025" : hasWorkout ? (dark ? "#22c55e12" : "#22c55e15") : hasPlanned ? (dark ? "#0ea5e912" : "#0ea5e915") : "transparent",
                        border: isToday ? `1px solid ${T.textMuted}` : isSelected ? "1px solid #e9456044" : "1px solid transparent",
                        transition: "all 0.15s",
                      }}>
                      <div style={{ fontSize: 11, fontWeight: isToday ? 800 : (hasWorkout || hasPlanned) ? 700 : 400, color: isSelected ? "#e94560" : hasWorkout ? "#22c55e" : hasPlanned ? "#0ea5e9" : isToday ? T.textStrong : T.textMuted }}>{day}</div>
                      {(hasWorkout || hasPlanned) && (
                        <div style={{ display: "flex", justifyContent: "center", gap: 2, marginTop: 2 }}>
                          {hasWorkout && Array.from({ length: Math.min(workoutCount, 3) }).map((_, j) => (
                            <div key={`w${j}`} style={{ width: 4, height: 4, borderRadius: "50%", background: "#22c55e" }} />
                          ))}
                          {hasPlanned && <div style={{ width: 4, height: 4, borderRadius: "50%", background: "#0ea5e9" }} />}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              {/* Selected day detail */}
              {selectedKey && (
                <div style={{ marginTop: 12 }}>
                  {/* Completed workouts */}
                  {selectedLogs.map((log, i) => (
                    <div key={`log-${i}`} onClick={() => { setExpandedLogIdx(log._idx); setView("history"); }}
                      style={{ ...S.card, display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" }}>
                      <div>
                        <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong }}>{log.name}</div>
                        <div style={{ fontSize: 9, color: T.textMuted, marginTop: 3 }}>
                          {log.exercises.map(e => e.name).join(" Â· ")}
                        </div>
                        <div style={{ fontSize: 10, color: T.textMuted, marginTop: 2 }}>{formatDate(log.date)}</div>
                        {log.location && (
                          <div style={{ display: "flex", alignItems: "center", gap: 3, marginTop: 2 }}>
                            <span style={{ color: "#0ea5e9" }}><MapPinIcon /></span>
                            <span style={{ fontSize: 9, color: "#0ea5e9" }}>{log.location}</span>
                          </div>
                        )}
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <div style={{ textAlign: "right" }}>
                          <div style={{ fontSize: 13, fontWeight: 700, color: "#e94560" }}>{log.exercises.length} exercises</div>
                          <div style={{ fontSize: 10, color: T.textMuted }}>
                            {log.exercises.reduce((s, ex) => s + (ex.workingSets || ex.sets || []).filter(set => set.completed).length, 0)} working sets
                          </div>
                        </div>
                        <span style={{ color: T.textFaint }}><ChevronIcon down={false} /></span>
                      </div>
                    </div>
                  ))}

                  {/* Planned workouts */}
                  {selectedPlans.map((plan, i) => (
                    <div key={`plan-${i}`} style={{ ...S.card, borderColor: "#0ea5e933", padding: 14 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8 }}>
                        <div>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            <span style={{ fontSize: 7, color: "#0ea5e9", background: "#0ea5e915", padding: "1px 6px", borderRadius: 3, fontWeight: 700, letterSpacing: 0.5 }}>PLANNED</span>
                          </div>
                          <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong, marginTop: 4 }}>{plan.name}</div>
                          <div style={{ fontSize: 9, color: T.textMuted, marginTop: 3 }}>
                            {plan.exerciseIds.map(id => allExercises.find(e => e.id === id)?.name).filter(Boolean).join(" Â· ")}
                          </div>
                          {plan.warmupNotes && <div style={{ fontSize: 9, color: "#f59e0b", marginTop: 3 }}>Warmup: {plan.warmupNotes}</div>}
                          {plan.cooldownNotes && <div style={{ fontSize: 9, color: "#8b5cf6", marginTop: 2 }}>Cooldown: {plan.cooldownNotes}</div>}
                        </div>
                        <button onClick={() => { if(confirm("Delete this planned workout?")) deletePlannedWorkout(plan.id); }}
                          style={{ background: "none", border: "none", color: "#e94560", cursor: "pointer", padding: 4, opacity: 0.5 }}>
                          <TrashIcon />
                        </button>
                      </div>
                      <div style={{ display: "flex", gap: 8 }}>
                        <button onClick={() => openPlanEditor(plan)} style={{ ...S.btnOutline("#0ea5e9"), flex: 1, padding: "10px 16px", fontSize: 11 }}>
                          <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><EditIcon /> EDIT PLAN</span>
                        </button>
                        <button onClick={() => {
                          setWorkoutDate(plan.date);
                          startPlannedWorkout(plan);
                        }} style={{ ...S.btn("#22c55e"), flex: 1, padding: "10px 16px", fontSize: 11 }}>
                          <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><PlayIcon /> START</span>
                        </button>
                      </div>
                    </div>
                  ))}

                  {/* Plan workout button */}
                  {!planningDate && (
                    <button onClick={() => {
                      const [y, m, d] = selectedKey.split("-").map(Number);
                      const dateStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                      setPlanningDate(dateStr);
                      setPlanExerciseConfigs([]);
                      setPlanName("");
                      setPlanWarmup("");
                      setPlanCooldown("");
                    }} style={{ ...S.btnOutline("#0ea5e9"), marginTop: 8, fontSize: 10, padding: "10px 16px" }}>
                      <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><PlusIcon /> PLAN WORKOUT FOR THIS DAY</span>
                    </button>
                  )}

                  {/* Inline planning view */}
                  {planningDate && selectedKey && (() => {
                    const [y, m, d] = selectedKey.split("-").map(Number);
                    const dateStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                    if (planningDate !== dateStr) return null;

                    const categories = [...new Set(allExercises.map(e => e.category))];
                    return (
                      <div style={{ ...S.card, padding: 0, marginTop: 8, borderColor: "#0ea5e933" }}>
                        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                          <span style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1 }}>PLAN WORKOUT</span>
                          <button onClick={() => setPlanningDate(null)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><XIcon /></button>
                        </div>

                        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
                          <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>WORKOUT NAME (optional)</div>
                          <input style={{ ...S.input, fontSize: 12 }} placeholder="Auto-generates from exercises" value={planName} onChange={e => setPlanName(e.target.value)} />
                        </div>

                        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
                          <div style={{ fontSize: 9, color: "#f59e0b", letterSpacing: 1, marginBottom: 4 }}>WARMUP (optional)</div>
                          <textarea style={{ ...S.input, fontSize: 11, minHeight: 36, resize: "vertical", lineHeight: 1.5, padding: "8px 10px", borderColor: "#f59e0b15" }}
                            placeholder="e.g. Leg swings, TRX squat & row, hurdle steps..."
                            value={planWarmup} onChange={e => setPlanWarmup(e.target.value)} />
                        </div>

                        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}` }}>
                          <div style={{ fontSize: 9, color: "#8b5cf6", letterSpacing: 1, marginBottom: 4 }}>COOLDOWN (optional)</div>
                          <textarea style={{ ...S.input, fontSize: 11, minHeight: 36, resize: "vertical", lineHeight: 1.5, padding: "8px 10px", borderColor: "#8b5cf615" }}
                            placeholder="e.g. Tabata finisher, stretching, foam rolling..."
                            value={planCooldown} onChange={e => setPlanCooldown(e.target.value)} />
                        </div>

                        <div style={{ maxHeight: 400, overflowY: "auto", padding: "8px 0" }}>
                          {categories.map(cat => {
                            const catExercises = allExercises.filter(e => e.category === cat);
                            const catInfo = CATEGORY_COLORS[cat] || { accent: "#888", label: cat };
                            return (
                              <div key={cat} style={{ padding: "0 12px" }}>
                                <div style={{ ...S.tag(catInfo.accent), marginTop: 8, marginBottom: 4 }}>{catInfo.label}</div>
                                {catExercises.map(ex => {
                                  const config = planExerciseConfigs.find(c => c.exerciseId === ex.id);
                                  const selected = !!config;
                                  const isCardio = ex.isCardio || ex.category === "cardio";
                                  const lastWeight = isCardio ? null : getLastWorkingWeight(ex.id, data.workoutLogs);
                                  const lastWarmup = isCardio ? null : getLastWarmupWeight(ex.id, data.workoutLogs);
                                  const suggestion = isCardio ? null : getProgressionSuggestion(ex.id, data.workoutLogs);

                                  const toggleExercise = (e) => {
                                    e.stopPropagation();
                                    if (selected) {
                                      setPlanExerciseConfigs(prev => prev.filter(c => c.exerciseId !== ex.id));
                                    } else {
                                      setPlanExerciseConfigs(prev => [...prev, {
                                        exerciseId: ex.id,
                                        targetWeight: lastWeight || 0,
                                        warmupWeight: lastWarmup || (lastWeight > 0 ? Math.round(lastWeight * 0.5 / 5) * 5 : 0),
                                        targetSets: 3,
                                        targetReps: 12,
                                      }]);
                                    }
                                  };

                                  const updateConfig = (field, value) => {
                                    setPlanExerciseConfigs(prev => prev.map(c =>
                                      c.exerciseId === ex.id ? { ...c, [field]: value } : c
                                    ));
                                  };

                                  return (
                                    <div key={ex.id} style={{ borderRadius: 6, marginBottom: 2, background: selected ? (dark ? "#0ea5e908" : "#0ea5e906") : "transparent" }}>
                                      <div onClick={toggleExercise}
                                        style={{ padding: "8px 12px", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                        <div>
                                          <div style={{ fontSize: 12, fontWeight: 600, color: selected ? T.textStrong : T.textMuted }}>{ex.name}</div>
                                          <div style={{ fontSize: 9, color: T.textFaint, marginTop: 1 }}>
                                            {ex.muscle}
                                            {!isCardio && lastWeight > 0 && <span style={{ color: T.textMuted }}> Â· Last: {lastWeight} lb</span>}
                                            {!isCardio && suggestion && <span style={{ color: "#22c55e" }}> Â· Suggested: {suggestion} lb</span>}
                                          </div>
                                        </div>
                                        <div style={{ width: 20, height: 20, borderRadius: 5, border: `2px solid ${selected ? "#0ea5e9" : T.borderInput}`, background: selected ? "#0ea5e920" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#0ea5e9", flexShrink: 0 }}>
                                          {selected && <CheckIcon />}
                                        </div>
                                      </div>

                                      {/* Expanded config for selected exercises */}
                                      {selected && !isCardio && (
                                        <div style={{ padding: "4px 12px 12px", display: "flex", gap: 8, flexWrap: "wrap" }}
                                          onClick={e => e.stopPropagation()}>
                                          <div style={{ flex: 1, minWidth: 70 }}>
                                            <div style={{ fontSize: 7, color: "#f59e0b", letterSpacing: 0.5, marginBottom: 2 }}>WARMUP</div>
                                            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                              <input type="number" value={config.warmupWeight || ""} placeholder="0"
                                                onChange={e => updateConfig("warmupWeight", Number(e.target.value) || 0)}
                                                style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#f59e0b25" }} />
                                              <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                            </div>
                                          </div>
                                          <div style={{ flex: 1, minWidth: 70 }}>
                                            <div style={{ fontSize: 7, color: "#22c55e", letterSpacing: 0.5, marginBottom: 2 }}>WORKING</div>
                                            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                                              <input type="number" value={config.targetWeight || ""} placeholder="0"
                                                onChange={e => updateConfig("targetWeight", Number(e.target.value) || 0)}
                                                style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, width: "100%", padding: "5px 4px", borderColor: "#22c55e25" }} />
                                              <span style={{ fontSize: 8, color: T.textFaint }}>lb</span>
                                            </div>
                                          </div>
                                          <div style={{ flex: 0.6, minWidth: 50 }}>
                                            <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>SETS</div>
                                            <input type="number" value={config.targetSets || ""} placeholder="3"
                                              onChange={e => updateConfig("targetSets", Number(e.target.value) || 0)}
                                              style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                          </div>
                                          <div style={{ flex: 0.6, minWidth: 50 }}>
                                            <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>REPS</div>
                                            <input type="number" value={config.targetReps || ""} placeholder="12"
                                              onChange={e => updateConfig("targetReps", Number(e.target.value) || 0)}
                                              style={{ ...S.input, fontSize: 12, textAlign: "center", fontWeight: 700, padding: "5px 4px" }} />
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            );
                          })}
                        </div>

                        {planExerciseConfigs.length > 1 && (
                          <div style={{ padding: "10px 16px", borderTop: `1px solid ${T.borderSubtle}` }}>
                            <div style={{ fontSize: 8, color: "#0ea5e9", letterSpacing: 1.5, marginBottom: 6 }}>EXERCISE ORDER</div>
                            {planExerciseConfigs.map((cfg, idx) => {
                              const ex = allExercises.find(e => e.id === cfg.exerciseId);
                              return (
                                <div key={cfg.exerciseId} style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 0", borderBottom: idx < planExerciseConfigs.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                                  <span style={{ fontSize: 9, color: T.textFaint, width: 16, textAlign: "center", fontWeight: 700 }}>{idx + 1}</span>
                                  <span style={{ flex: 1, fontSize: 11, color: T.textStrong, fontWeight: 600 }}>{ex?.name || "Unknown"}</span>
                                  <button onClick={() => idx > 0 && setPlanExerciseConfigs(moveItem(planExerciseConfigs, idx, idx - 1))}
                                    style={{ background: "none", border: "none", color: idx > 0 ? "#0ea5e9" : T.borderInput, cursor: idx > 0 ? "pointer" : "default", padding: 4 }}>
                                    <ArrowUpSmall />
                                  </button>
                                  <button onClick={() => idx < planExerciseConfigs.length - 1 && setPlanExerciseConfigs(moveItem(planExerciseConfigs, idx, idx + 1))}
                                    style={{ background: "none", border: "none", color: idx < planExerciseConfigs.length - 1 ? "#0ea5e9" : T.borderInput, cursor: idx < planExerciseConfigs.length - 1 ? "pointer" : "default", padding: 4 }}>
                                    <ArrowDownSmall />
                                  </button>
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {planExerciseConfigs.length > 0 && (
                          <div style={{ padding: "12px 16px", borderTop: `1px solid ${T.borderSubtle}` }}>
                            <button onClick={() => savePlannedWorkout(planningDate, planName)}
                              style={{ ...S.btn("#0ea5e9"), padding: "12px 16px" }}>
                              <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>SAVE PLAN ({planExerciseConfigs.length} exercises)</span>
                            </button>
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* View all history link */}
              <button onClick={() => setView("history")} style={{ ...S.btnOutline(T.textMuted), marginTop: 12, fontSize: 9 }}>VIEW FULL HISTORY</button>
            </div>
          );
        })()}

        {totalWorkouts > 0 && (
          <div style={{ textAlign: "center", marginTop: 20 }}>
            <span style={{ fontSize: 8, color: T.textFaint }}>Need to reset? Go to Settings in the Exercises tab</span>
          </div>
        )}
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUILD WORKOUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderBuild = () => {
    const categories = [...new Set(allExercises.map(e => e.category))];
    return (
      <div>
        <div style={{ marginBottom: 16 }}>
          <div style={{ ...S.sectionLabel, color: T.textMuted }}>Workout Name</div>
          <input style={S.input} placeholder="e.g. Posterior Chain + Back" value={workoutName} onChange={e => setWorkoutName(e.target.value)} />
        </div>

        <div style={{ marginBottom: 16 }}>
          <div style={{ ...S.sectionLabel, color: T.textMuted }}>Date</div>
          <input type="date" value={workoutDate} onChange={e => setWorkoutDate(e.target.value)}
            max={new Date().toISOString().split("T")[0]}
            style={{ ...S.input, width: "auto" }} />
          {workoutDate !== new Date().toISOString().split("T")[0] && (
            <div style={{ display: "flex", alignItems: "center", gap: 6, marginTop: 6 }}>
              <span style={{ fontSize: 9, color: "#f59e0b", fontWeight: 600 }}>â® BACKDATED ENTRY</span>
              <button onClick={() => setWorkoutDate(new Date().toISOString().split("T")[0])}
                style={{ background: "none", border: "none", color: T.textFaint, cursor: "pointer", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", textDecoration: "underline" }}>reset to today</button>
            </div>
          )}
        </div>

        {/* Location picker */}
        <div style={{ marginBottom: 16 }}>
          <div style={{ ...S.sectionLabel, color: T.textMuted }}><MapPinIcon /> Location</div>

          {/* Selected location display */}
          {workoutLocation ? (
            <div style={{ ...S.card, padding: "10px 14px", display: "flex", justifyContent: "space-between", alignItems: "center", borderColor: "#22c55e44" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ color: "#22c55e" }}><MapPinIcon /></span>
                <span style={{ fontSize: 12, fontWeight: 600, color: T.textStrong }}>{workoutLocation}</span>
              </div>
              <button onClick={() => setWorkoutLocation("")} style={{ background: "none", border: "none", color: T.textFaint, cursor: "pointer", padding: 4 }}><XIcon /></button>
            </div>
          ) : (
            <div>
              {/* Search/manual input */}
              <div style={{ display: "flex", gap: 6, marginBottom: 8 }}>
                <input style={{ ...S.input, flex: 1 }} placeholder="Type gym name..." value={locationSearch}
                  onChange={e => setLocationSearch(e.target.value)}
                  onKeyDown={e => { if (e.key === "Enter" && locationSearch.trim()) { setWorkoutLocation(locationSearch.trim()); setLocationSearch(""); }}} />
                <button onClick={() => { if (locationSearch.trim()) { setWorkoutLocation(locationSearch.trim()); setLocationSearch(""); }}}
                  style={{ ...S.btn("#22c55e"), width: "auto", padding: "8px 14px", fontSize: 10 }}>SET</button>
              </div>

              {/* Recent gyms */}
              {getRecentGyms().length > 0 && (
                <div>
                  <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1, marginBottom: 4 }}>RECENT</div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                    {getRecentGyms().map((gym, i) => (
                      <button key={i} onClick={() => setWorkoutLocation(gym)}
                        style={{ background: T.bgInset, border: `1px solid ${T.borderInput}`, borderRadius: 6, padding: "6px 10px", fontSize: 10, color: T.text, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace" }}>
                        {gym}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        <div style={{ ...S.sectionLabel, color: T.textMuted, marginBottom: 14 }}>Select Exercises ({selectedExercises.length})</div>

        {categories.map(cat => {
          const catExercises = allExercises.filter(e => e.category === cat);
          const catInfo = CATEGORY_COLORS[cat] || { accent: "#888", label: cat };
          return (
            <div key={cat} style={{ marginBottom: 14 }}>
              <div style={S.tag(catInfo.accent)}>{catInfo.label}</div>
              {catExercises.map(ex => {
                const selected = selectedExercises.includes(ex.id);
                const pr = getPR(ex.id, data.workoutLogs);
                return (
                  <div key={ex.id} onClick={() => setSelectedExercises(prev => selected ? prev.filter(id => id !== ex.id) : [...prev, ex.id])}
                    style={{ ...S.card, marginBottom: 4, padding: "10px 14px", cursor: "pointer", borderColor: selected ? catInfo.accent + "66" : T.border, display: "flex", justifyContent: "space-between", alignItems: "center", transition: "border-color 0.15s" }}>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 600, color: selected ? T.textStrong : T.textMuted }}>{ex.name}</div>
                      <div style={{ fontSize: 9, color: T.textFaint, marginTop: 1 }}>{ex.muscle}</div>
                    </div>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      {pr && <span style={{ fontSize: 9, color: "#22c55e" }}>PR: {pr}lb</span>}
                      <div style={{ width: 20, height: 20, borderRadius: 5, border: `2px solid ${selected ? catInfo.accent : T.borderInput}`, background: selected ? catInfo.accent + "20" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: catInfo.accent }}>
                        {selected && <CheckIcon />}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          );
        })}

        {selectedExercises.length > 0 && (
          <div style={{ position: "sticky", bottom: 70, paddingTop: 12 }}>
            <button style={S.btn()} onClick={startWorkout}>START ({selectedExercises.length} EXERCISES)</button>
          </div>
        )}
        <button onClick={() => setView("dashboard")} style={{ ...S.btnOutline("#555"), marginTop: 8 }}>CANCEL</button>
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const getVideoUrl = (ex) => {
    if (data.videoOverrides && data.videoOverrides[ex.id]) return data.videoOverrides[ex.id];
    return ex.videoUrl || "";
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACTIVE WORKOUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderActive = () => {
    if (!activeWorkout) return null;

    const updateField = (exIdx, field, value) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      updated.exercises[exIdx] = { ...updated.exercises[exIdx], [field]: value };
      setActiveWorkout(updated);
    };

    const toggleSet = (exIdx, setType, setIdx) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      const ex = { ...updated.exercises[exIdx] };
      const key = setType === "warmup" ? "warmupSets" : "workingSets";
      ex[key] = [...ex[key]];
      ex[key][setIdx] = { ...ex[key][setIdx], completed: !ex[key][setIdx].completed };
      if (ex[key][setIdx].completed && ex[key][setIdx].reps === 0) ex[key][setIdx].reps = setType === "warmup" ? 6 : 12;
      if (setType === "working" && ex[key][setIdx].completed && !ex[key][setIdx].weight) {
        ex[key][setIdx].weight = ex.workingWeight || 0;
      }
      updated.exercises[exIdx] = ex;
      setActiveWorkout(updated);
    };

    const updateReps = (exIdx, setType, setIdx, reps) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      const ex = { ...updated.exercises[exIdx] };
      const key = setType === "warmup" ? "warmupSets" : "workingSets";
      ex[key] = [...ex[key]];
      ex[key][setIdx] = { ...ex[key][setIdx], reps: parseInt(reps) || 0 };
      updated.exercises[exIdx] = ex;
      setActiveWorkout(updated);
    };

    const updateSetWeight = (exIdx, setIdx, weight) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      const ex = { ...updated.exercises[exIdx] };
      ex.workingSets = [...ex.workingSets];
      ex.workingSets[setIdx] = { ...ex.workingSets[setIdx], weight: parseFloat(weight) || 0 };
      // Also update the exercise-level workingWeight to the new value so future sets inherit it
      ex.workingWeight = parseFloat(weight) || ex.workingWeight;
      updated.exercises[exIdx] = ex;
      setActiveWorkout(updated);
    };

    const addSet = (exIdx, setType) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      const ex = { ...updated.exercises[exIdx] };
      const key = setType === "warmup" ? "warmupSets" : "workingSets";
      const newSet = setType === "working" ? { reps: 0, completed: false, weight: null } : { reps: 0, completed: false };
      ex[key] = [...ex[key], newSet];
      updated.exercises[exIdx] = ex;
      setActiveWorkout(updated);
    };

    const removeSet = (exIdx, setType) => {
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises] };
      const ex = { ...updated.exercises[exIdx] };
      const key = setType === "warmup" ? "warmupSets" : "workingSets";
      if (ex[key].length > 1) {
        ex[key] = ex[key].slice(0, -1);
        updated.exercises[exIdx] = ex;
        setActiveWorkout(updated);
      }
    };

    const removeExercise = (exIdx) => {
      const ex = activeWorkout.exercises[exIdx];
      const hasProgress = ex.isCardio
        ? ex.completed
        : (ex.warmupSets || []).some(s => s.completed) || (ex.workingSets || []).some(s => s.completed);
      if (hasProgress && !confirm(`Remove "${ex.name}"? You have logged sets on this exercise.`)) return;
      if (!hasProgress && !confirm(`Remove "${ex.name}" from this workout?`)) return;
      const updated = { ...activeWorkout, exercises: activeWorkout.exercises.filter((_, i) => i !== exIdx) };
      setActiveWorkout(updated);
    };

    const swapExercise = (exIdx, newExerciseId) => {
      const newEx = allExercises.find(e => e.id === newExerciseId);
      if (!newEx) return;
      const isCardio = newEx.isCardio || newEx.category === "cardio";
      const oldEx = activeWorkout.exercises[exIdx];

      let replacement;
      if (isCardio) {
        const lastCardio = getLastCardioStats(newExerciseId, data.workoutLogs);
        replacement = {
          exerciseId: newExerciseId, name: newEx.name, category: newEx.category, isCardio: true,
          duration: lastCardio?.duration || 0, distance: lastCardio?.distance || 0,
          calories: lastCardio?.calories || 0, avgHeartRate: lastCardio?.avgHeartRate || 0,
          notes: "Swapped from: " + oldEx.name, completed: false,
        };
      } else {
        const lastWorking = getLastWorkingWeight(newExerciseId, data.workoutLogs);
        const lastWarmup = getLastWarmupWeight(newExerciseId, data.workoutLogs);
        const suggestion = getProgressionSuggestion(newExerciseId, data.workoutLogs);
        const pr = getPR(newExerciseId, data.workoutLogs);
        replacement = {
          exerciseId: newExerciseId, name: newEx.name, category: newEx.category,
          warmupWeight: lastWarmup || (lastWorking > 0 ? Math.round(lastWorking * 0.5 / 5) * 5 : 0),
          workingWeight: lastWorking || 0,
          warmupSets: [{ reps: 0, completed: false }],
          workingSets: [
            { reps: 0, completed: false, weight: null },
            { reps: 0, completed: false, weight: null },
            { reps: 0, completed: false, weight: null },
          ],
          notes: "Swapped from: " + oldEx.name,
          pr, suggestion, lastWorking,
        };
      }

      const exercises = [...activeWorkout.exercises];
      exercises[exIdx] = replacement;
      setActiveWorkout({ ...activeWorkout, exercises });
      setSwappingExerciseIdx(null);
    };

    const addExerciseMidWorkout = (id) => {
      const ex = allExercises.find(e => e.id === id);
      if (!ex) return;
      const isCardio = ex.isCardio || ex.category === "cardio";

      let newEx;
      if (isCardio) {
        const lastCardio = getLastCardioStats(id, data.workoutLogs);
        newEx = {
          exerciseId: id, name: ex.name, category: ex.category, isCardio: true,
          duration: lastCardio?.duration || 0, distance: lastCardio?.distance || 0,
          calories: lastCardio?.calories || 0, avgHeartRate: lastCardio?.avgHeartRate || 0,
          notes: "", completed: false,
        };
      } else {
        const lastWorking = getLastWorkingWeight(id, data.workoutLogs);
        const lastWarmup = getLastWarmupWeight(id, data.workoutLogs);
        const suggestion = getProgressionSuggestion(id, data.workoutLogs);
        const pr = getPR(id, data.workoutLogs);
        newEx = {
          exerciseId: id, name: ex.name, category: ex.category,
          warmupWeight: lastWarmup || (lastWorking > 0 ? Math.round(lastWorking * 0.5 / 5) * 5 : 0),
          workingWeight: lastWorking || 0,
          warmupSets: [{ reps: 0, completed: false }],
          workingSets: [
            { reps: 0, completed: false, weight: null },
            { reps: 0, completed: false, weight: null },
            { reps: 0, completed: false, weight: null },
          ],
          notes: "", pr, suggestion, lastWorking,
        };
      }
      const updated = { ...activeWorkout, exercises: [...activeWorkout.exercises, newEx] };
      setActiveWorkout(updated);
      setShowMidWorkoutPicker(false);
    };

    const totalSets = activeWorkout.exercises.reduce((s, ex) => ex.isCardio ? s + 1 : s + (ex.warmupSets || []).length + (ex.workingSets || []).length, 0);
    const completedSets = activeWorkout.exercises.reduce((s, ex) => ex.isCardio ? s + (ex.completed ? 1 : 0) : s + (ex.warmupSets || []).filter(s => s.completed).length + (ex.workingSets || []).filter(s => s.completed).length, 0);
    const progress = totalSets > 0 ? (completedSets / totalSets * 100) : 0;

    return (
      <div>
        {/* Progress */}
        <div style={{ marginBottom: 20 }}>
          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
            <div>
              {editingLogIdx !== null && (
                <div style={{ fontSize: 8, color: "#f59e0b", letterSpacing: 1.5, fontWeight: 700, marginBottom: 2 }}>âœ EDITING</div>
              )}
              <span style={{ fontSize: 10, color: T.textMuted, letterSpacing: 1.5 }}>{activeWorkout.name.toUpperCase()}</span>
              {activeWorkout.location && (
                <div style={{ display: "flex", alignItems: "center", gap: 3, marginTop: 2 }}>
                  <span style={{ color: "#0ea5e9" }}><MapPinIcon /></span>
                  <span style={{ fontSize: 9, color: "#0ea5e9" }}>{activeWorkout.location}</span>
                </div>
              )}
            </div>
            <span style={{ fontSize: 10, color: "#e94560", fontWeight: 700 }}>{completedSets}/{totalSets} SETS</span>
          </div>
          <div style={{ height: 3, background: T.borderSubtle, borderRadius: 2, overflow: "hidden" }}>
            <div style={{ height: "100%", width: `${progress}%`, background: "linear-gradient(90deg, #e94560, #f59e0b)", borderRadius: 2, transition: "width 0.3s" }} />
          </div>
        </div>

        {/* â”€â”€ WARMUP NOTES â”€â”€ */}
        <div style={{ ...S.card, padding: 0, marginBottom: 12, borderColor: "#f59e0b22" }}>
          <div style={{ padding: "10px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", alignItems: "center", gap: 6 }}>
            <span style={{ fontSize: 11, color: "#f59e0b" }}>~</span>
            <span style={{ fontSize: 9, fontWeight: 700, color: "#f59e0b", letterSpacing: 1.5 }}>WARMUP</span>
          </div>
          <div style={{ padding: "10px 16px" }}>
            <textarea
              value={activeWorkout.warmupNotes || ""}
              onChange={e => setActiveWorkout({ ...activeWorkout, warmupNotes: e.target.value })}
              placeholder="Leg swings, hurdle steps, TRX squat & row, band pull-aparts..."
              style={{
                ...S.input,
                minHeight: 44,
                resize: "vertical",
                fontSize: 11,
                lineHeight: 1.6,
                padding: "8px 10px",
                borderColor: "#f59e0b15",
              }}
            />
          </div>
        </div>

        {activeWorkout.exercises.map((ex, exIdx) => {
          const exInfo = allExercises.find(e => e.id === ex.exerciseId);
          const catInfo = CATEGORY_COLORS[exInfo?.category] || { accent: "#888" };

          // â”€â”€ CARDIO EXERCISE â”€â”€
          if (ex.isCardio) {
            return (
              <div key={exIdx} style={{ ...S.card, borderColor: ex.completed ? "#22c55e22" : T.border, position: "relative", overflow: "hidden", padding: 0 }}>
                {ex.completed && <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 2, background: "#22c55e" }} />}

                <div style={{ padding: "14px 16px 10px", borderBottom: `1px solid ${T.borderSubtle}` }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                    <div>
                      <div style={S.tag(catInfo.accent)}>{CATEGORY_COLORS[ex.category]?.label}</div>
                      <div style={{ fontSize: 14, fontWeight: 700, color: ex.completed ? "#22c55e" : T.textStrong, marginTop: 6 }}>{ex.name}</div>
                    </div>
                    <button onClick={() => setSwappingExerciseIdx(swappingExerciseIdx === exIdx ? null : exIdx)}
                      style={{ background: swappingExerciseIdx === exIdx ? "#0ea5e915" : "none", border: `1px solid ${swappingExerciseIdx === exIdx ? "#0ea5e9" : "#0ea5e925"}`, borderRadius: 4, color: "#0ea5e9", cursor: "pointer", padding: "4px 6px", display: "flex", alignItems: "center", flexShrink: 0, opacity: swappingExerciseIdx === exIdx ? 1 : 0.6 }}>
                      <SwapIcon />
                    </button>
                    <button onClick={() => removeExercise(exIdx)}
                      style={{ background: "none", border: `1px solid #e9456025`, borderRadius: 4, color: "#e94560", cursor: "pointer", padding: "4px 6px", display: "flex", alignItems: "center", flexShrink: 0, opacity: 0.5 }}>
                      <XIcon />
                    </button>
                  </div>
                </div>

                {/* Cardio swap panel */}
                {swappingExerciseIdx === exIdx && (() => {
                  const currentIds = activeWorkout.exercises.map(e => e.exerciseId);
                  const cardioAlts = allExercises.filter(e =>
                    e.id !== ex.exerciseId && !currentIds.includes(e.id) && (e.isCardio || e.category === "cardio")
                  );
                  return (
                    <div style={{ padding: "10px 16px", background: dark ? "#0ea5e908" : "#0ea5e906", borderBottom: `1px solid ${T.borderSubtle}` }}>
                      <div style={{ fontSize: 8, color: "#0ea5e9", letterSpacing: 1.5, fontWeight: 700, marginBottom: 6 }}>SWAP â€” OTHER CARDIO</div>
                      {cardioAlts.length === 0 && (
                        <div style={{ fontSize: 10, color: T.textFaint, padding: "8px 0" }}>No other cardio exercises available</div>
                      )}
                      {cardioAlts.map(alt => (
                        <button key={alt.id} onClick={() => swapExercise(exIdx, alt.id)}
                          style={{ display: "flex", justifyContent: "space-between", alignItems: "center", width: "100%", padding: "8px 10px", marginBottom: 3, background: dark ? "#1a1a2e" : "#fff", border: `1px solid ${T.borderSubtle}`, borderRadius: 6, cursor: "pointer", textAlign: "left" }}>
                          <div>
                            <div style={{ fontSize: 11, fontWeight: 600, color: T.textStrong }}>{alt.name}</div>
                            <div style={{ fontSize: 8, color: T.textFaint }}>{alt.muscle}</div>
                          </div>
                        </button>
                      ))}
                      <button onClick={() => setSwappingExerciseIdx(null)}
                        style={{ ...S.btnOutline("#666"), fontSize: 9, padding: "6px 12px", marginTop: 6, width: "100%" }}>CANCEL</button>
                    </div>
                  );
                })()}

                <div style={{ padding: "12px 16px" }}>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 10 }}>
                    <div>
                      <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1, marginBottom: 3 }}>DURATION (min)</div>
                      <input type="number" style={{ ...S.input, fontSize: 14, textAlign: "center", fontWeight: 700 }}
                        value={ex.duration || ""} placeholder="30"
                        onChange={e => updateField(exIdx, "duration", Number(e.target.value) || 0)} />
                    </div>
                    <div>
                      <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1, marginBottom: 3 }}>DISTANCE (mi)</div>
                      <input type="number" step="0.1" style={{ ...S.input, fontSize: 14, textAlign: "center", fontWeight: 700 }}
                        value={ex.distance || ""} placeholder="0.0"
                        onChange={e => updateField(exIdx, "distance", Number(e.target.value) || 0)} />
                    </div>
                    <div>
                      <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1, marginBottom: 3 }}>CALORIES</div>
                      <input type="number" style={{ ...S.input, fontSize: 14, textAlign: "center", fontWeight: 700 }}
                        value={ex.calories || ""} placeholder="0"
                        onChange={e => updateField(exIdx, "calories", Number(e.target.value) || 0)} />
                    </div>
                    <div>
                      <div style={{ fontSize: 8, color: T.textFaint, letterSpacing: 1, marginBottom: 3 }}>AVG HR (bpm)</div>
                      <input type="number" style={{ ...S.input, fontSize: 14, textAlign: "center", fontWeight: 700 }}
                        value={ex.avgHeartRate || ""} placeholder="0"
                        onChange={e => updateField(exIdx, "avgHeartRate", Number(e.target.value) || 0)} />
                    </div>
                  </div>

                  {/* Notes */}
                  <textarea value={ex.notes || ""} onChange={e => updateField(exIdx, "notes", e.target.value)}
                    placeholder="Class name, instructor, how it felt..."
                    style={{ ...S.input, minHeight: 40, resize: "vertical", fontSize: 11, lineHeight: 1.5, border: `1px solid ${T.borderInput}` }} />

                  {/* Complete toggle */}
                  <button onClick={() => updateField(exIdx, "completed", !ex.completed)}
                    style={{ ...ex.completed ? S.btn("#22c55e") : S.btnOutline("#22c55e"), marginTop: 10, padding: "10px 14px" }}>
                    <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>
                      <CheckIcon /> {ex.completed ? "COMPLETED âœ“" : "MARK COMPLETE"}
                    </span>
                  </button>
                </div>
              </div>
            );
          }

          // â”€â”€ STRENGTH EXERCISE â”€â”€
          const allWarmupDone = (ex.warmupSets || []).every(s => s.completed);
          const allWorkingDone = (ex.workingSets || []).every(s => s.completed);
          const allDone = allWarmupDone && allWorkingDone;
          const maxSetWeight = Math.max(ex.workingWeight || 0, ...ex.workingSets.map(s => s.weight || 0));
          const isNewPR = maxSetWeight > 0 && ex.pr && maxSetWeight > ex.pr && allWorkingDone;

          return (
            <div key={exIdx} style={{ ...S.card, borderColor: allDone ? "#22c55e22" : T.border, position: "relative", overflow: "hidden", padding: 0 }}>
              {allDone && <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 2, background: "#22c55e" }} />}

              {/* Exercise header */}
              <div style={{ padding: "14px 16px 10px", borderBottom: `1px solid ${T.borderSubtle}` }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                  <div>
                    <div style={S.tag(catInfo.accent)}>{CATEGORY_COLORS[ex.category]?.label}</div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: allDone ? "#22c55e" : T.textStrong, marginTop: 6 }}>{ex.name}</div>
                    <div style={{ display: "flex", gap: 10, marginTop: 4, alignItems: "center", flexWrap: "wrap" }}>
                      {ex.pr > 0 && <span style={{ fontSize: 9, color: "#f59e0b", letterSpacing: 0.5 }}>PR: {ex.pr} lb</span>}
                      {ex.suggestion && <span style={{ fontSize: 9, color: T.textMuted }}>Target: {ex.suggestion} lb</span>}
                      {ex.lastWorking > 0 && <span style={{ fontSize: 9, color: T.textFaint }}>Last: {ex.lastWorking} lb</span>}
                    </div>
                  </div>
                  {exInfo?.videoUrl && (
                    <a href={getVideoUrl(exInfo)} target="_blank" rel="noopener noreferrer"
                      style={{ color: catInfo.accent, display: "flex", alignItems: "center", gap: 4, fontSize: 9, textDecoration: "none", padding: "4px 8px", borderRadius: 4, border: `1px solid ${catInfo.accent}25`, letterSpacing: 0.5, flexShrink: 0 }}>
                      <PlayIcon /> Form
                    </a>
                  )}
                  <button onClick={() => setSwappingExerciseIdx(swappingExerciseIdx === exIdx ? null : exIdx)}
                    style={{ background: swappingExerciseIdx === exIdx ? "#0ea5e915" : "none", border: `1px solid ${swappingExerciseIdx === exIdx ? "#0ea5e9" : "#0ea5e925"}`, borderRadius: 4, color: "#0ea5e9", cursor: "pointer", padding: "4px 6px", display: "flex", alignItems: "center", flexShrink: 0, opacity: swappingExerciseIdx === exIdx ? 1 : 0.6 }}>
                    <SwapIcon />
                  </button>
                  <button onClick={() => removeExercise(exIdx)}
                    style={{ background: "none", border: `1px solid #e9456025`, borderRadius: 4, color: "#e94560", cursor: "pointer", padding: "4px 6px", display: "flex", alignItems: "center", flexShrink: 0, opacity: 0.5 }}>
                    <XIcon />
                  </button>
                </div>
                {isNewPR && (
                  <div style={{ marginTop: 8, display: "flex", alignItems: "center", gap: 6, padding: "4px 10px", background: "#f59e0b12", borderRadius: 6, border: "1px solid #f59e0b33" }}>
                    <span style={{ color: "#f59e0b" }}><FlameIcon /></span>
                    <span style={{ fontSize: 10, fontWeight: 700, color: "#f59e0b", letterSpacing: 0.5 }}>NEW PR!</span>
                  </div>
                )}
              </div>

              {/* â”€â”€ SWAP PANEL â”€â”€ */}
              {swappingExerciseIdx === exIdx && (() => {
                const currentMuscle = exInfo?.muscle || "";
                const currentCategory = ex.category;
                const currentIds = activeWorkout.exercises.map(e => e.exerciseId);
                // Find alternatives: same muscle first, then same category
                const sameMuscle = allExercises.filter(e =>
                  e.id !== ex.exerciseId && !currentIds.includes(e.id) &&
                  e.muscle === currentMuscle && !e.isCardio
                );
                const sameCategory = allExercises.filter(e =>
                  e.id !== ex.exerciseId && !currentIds.includes(e.id) &&
                  e.category === currentCategory && e.muscle !== currentMuscle && !e.isCardio
                );
                const alternatives = [...sameMuscle, ...sameCategory];
                return (
                  <div style={{ padding: "10px 16px", background: dark ? "#0ea5e908" : "#0ea5e906", borderBottom: `1px solid ${T.borderSubtle}` }}>
                    <div style={{ fontSize: 8, color: "#0ea5e9", letterSpacing: 1.5, fontWeight: 700, marginBottom: 6 }}>
                      <SwapIcon /> SWAP â€” SAME MUSCLE ALTERNATIVES
                    </div>
                    {alternatives.length === 0 && (
                      <div style={{ fontSize: 10, color: T.textFaint, padding: "8px 0" }}>No alternatives found for {currentMuscle}</div>
                    )}
                    {sameMuscle.length > 0 && (
                      <div style={{ marginBottom: sameCategory.length > 0 ? 8 : 0 }}>
                        <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 1, marginBottom: 4 }}>SAME MUSCLE ({currentMuscle})</div>
                        {sameMuscle.map(alt => {
                          const lastW = getLastWorkingWeight(alt.id, data.workoutLogs);
                          return (
                            <button key={alt.id} onClick={() => swapExercise(exIdx, alt.id)}
                              style={{ display: "flex", justifyContent: "space-between", alignItems: "center", width: "100%", padding: "8px 10px", marginBottom: 3, background: dark ? "#1a1a2e" : "#fff", border: `1px solid ${T.borderSubtle}`, borderRadius: 6, cursor: "pointer", textAlign: "left" }}>
                              <div>
                                <div style={{ fontSize: 11, fontWeight: 600, color: T.textStrong }}>{alt.name}</div>
                                <div style={{ fontSize: 8, color: T.textFaint }}>{alt.muscle}</div>
                              </div>
                              {lastW > 0 && <span style={{ fontSize: 9, color: T.textMuted }}>Last: {lastW} lb</span>}
                            </button>
                          );
                        })}
                      </div>
                    )}
                    {sameCategory.length > 0 && (
                      <div>
                        <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 1, marginBottom: 4 }}>SAME CATEGORY ({CATEGORY_COLORS[currentCategory]?.label})</div>
                        {sameCategory.map(alt => {
                          const lastW = getLastWorkingWeight(alt.id, data.workoutLogs);
                          return (
                            <button key={alt.id} onClick={() => swapExercise(exIdx, alt.id)}
                              style={{ display: "flex", justifyContent: "space-between", alignItems: "center", width: "100%", padding: "8px 10px", marginBottom: 3, background: dark ? "#1a1a2e" : "#fff", border: `1px solid ${T.borderSubtle}`, borderRadius: 6, cursor: "pointer", textAlign: "left" }}>
                              <div>
                                <div style={{ fontSize: 11, fontWeight: 600, color: T.textStrong }}>{alt.name}</div>
                                <div style={{ fontSize: 8, color: T.textFaint }}>{alt.muscle}</div>
                              </div>
                              {lastW > 0 && <span style={{ fontSize: 9, color: T.textMuted }}>Last: {lastW} lb</span>}
                            </button>
                          );
                        })}
                      </div>
                    )}
                    <button onClick={() => setSwappingExerciseIdx(null)}
                      style={{ ...S.btnOutline("#666"), fontSize: 9, padding: "6px 12px", marginTop: 6, width: "100%" }}>CANCEL</button>
                  </div>
                );
              })()}

              {/* â”€â”€ WARMUP SECTION â”€â”€ */}
              <div style={{ padding: "12px 16px", background: T.bgInset, borderBottom: `1px solid ${T.borderSubtle}` }}>
                <div style={{ ...S.sectionLabel, color: "#f59e0b" }}>
                  <span style={{ fontSize: 11 }}>~</span> WARMUP
                </div>

                {/* Warmup weight */}
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <input type="number" value={ex.warmupWeight || ""} onChange={e => updateField(exIdx, "warmupWeight", parseFloat(e.target.value) || 0)}
                    style={{ ...S.input, width: 80, textAlign: "center", fontSize: 15, fontWeight: 700, borderColor: "#f59e0b33", padding: "6px 10px" }} placeholder="0" />
                  <span style={{ fontSize: 11, color: T.textMuted }}>lb</span>
                  <span style={{ fontSize: 9, color: T.textFaint, marginLeft: "auto" }}>lighter weight, groove the pattern</span>
                </div>

                {/* Warmup sets */}
                <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
                  {ex.warmupSets.map((set, setIdx) => (
                    <div key={setIdx} style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 3 }}>
                      <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 0.5 }}>W{setIdx + 1}</div>
                      <button onClick={() => toggleSet(exIdx, "warmup", setIdx)} style={S.setBtn(set.completed, true)}>
                        {set.completed ? <CheckIcon /> : "â€”"}
                      </button>
                      {set.completed && (
                        <input type="number" value={set.reps || ""} onChange={e => updateReps(exIdx, "warmup", setIdx, e.target.value)}
                          style={{ ...S.input, width: 42, padding: "2px 4px", textAlign: "center", fontSize: 10, borderColor: "#f59e0b22" }} placeholder="10" />
                      )}
                    </div>
                  ))}
                  <div style={{ display: "flex", flexDirection: "column", gap: 2, marginTop: 12 }}>
                    <button onClick={() => addSet(exIdx, "warmup")} style={{ ...S.setBtn(false, true), width: 32, height: 20, borderRadius: 4, borderStyle: "dashed", borderColor: "#f59e0b33" }}><PlusIcon /></button>
                    {ex.warmupSets.length > 1 && (
                      <button onClick={() => removeSet(exIdx, "warmup")} style={{ ...S.setBtn(false, true), width: 32, height: 20, borderRadius: 4, borderStyle: "dashed", borderColor: "#f59e0b22", color: T.textFaint }}><MinusIcon /></button>
                    )}
                  </div>
                </div>
              </div>

              {/* â”€â”€ WORKING SETS SECTION â”€â”€ */}
              <div style={{ padding: "12px 16px" }}>
                <div style={{ ...S.sectionLabel, color: "#22c55e" }}>
                  <span style={{ color: "#22c55e" }}><FlameIcon /></span> WORKING SETS
                </div>

                {/* Default working weight */}
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <input type="number" value={ex.workingWeight || ""} onChange={e => updateField(exIdx, "workingWeight", parseFloat(e.target.value) || 0)}
                    style={{ ...S.input, width: 80, textAlign: "center", fontSize: 15, fontWeight: 700, borderColor: "#22c55e33", padding: "6px 10px" }} placeholder="0" />
                  <span style={{ fontSize: 11, color: T.textMuted }}>lb</span>
                  <span style={{ fontSize: 9, color: T.textFaint, marginLeft: "auto" }}>starting weight</span>
                </div>

                {/* Working sets with per-set weight */}
                <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                  {ex.workingSets.map((set, setIdx) => {
                    const setWeight = set.weight != null ? set.weight : ex.workingWeight;
                    const weightChanged = set.weight != null && set.weight !== ex.workingWeight;
                    return (
                      <div key={setIdx} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: setIdx < ex.workingSets.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                        <button onClick={() => toggleSet(exIdx, "working", setIdx)} style={S.setBtn(set.completed, false)}>
                          {set.completed ? <CheckIcon /> : <span style={{ fontSize: 10 }}>S{setIdx + 1}</span>}
                        </button>
                        <div style={{ flex: 1, display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                            <input type="number" value={set.weight != null ? set.weight : (ex.workingWeight || "")}
                              onChange={e => updateSetWeight(exIdx, setIdx, e.target.value)}
                              style={{ ...S.input, width: 62, textAlign: "center", fontSize: 13, fontWeight: 700, padding: "4px 6px",
                                borderColor: weightChanged ? "#f59e0b44" : "#22c55e22",
                                color: weightChanged ? "#f59e0b" : T.inputText }} placeholder="0" />
                            <span style={{ fontSize: 9, color: T.textMuted }}>lb</span>
                          </div>
                          <span style={{ fontSize: 9, color: T.textFaint }}>Ã—</span>
                          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                            <input type="number" value={set.reps || ""} onChange={e => updateReps(exIdx, "working", setIdx, e.target.value)}
                              style={{ ...S.input, width: 42, textAlign: "center", fontSize: 13, fontWeight: 700, padding: "4px 6px", borderColor: "#22c55e22" }} placeholder="12" />
                            <span style={{ fontSize: 9, color: T.textMuted }}>reps</span>
                          </div>
                          {weightChanged && <span style={{ fontSize: 8, color: "#f59e0b", letterSpacing: 0.5 }}>BUMPED</span>}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Add/remove set buttons */}
                <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                  <button onClick={() => addSet(exIdx, "working")} style={{ ...S.btnOutline("#22c55e"), padding: "6px 12px", fontSize: 9, width: "auto", display: "flex", alignItems: "center", gap: 4 }}><PlusIcon /> SET</button>
                  {ex.workingSets.length > 1 && (
                    <button onClick={() => removeSet(exIdx, "working")} style={{ ...S.btnOutline("#333"), padding: "6px 12px", fontSize: 9, width: "auto", display: "flex", alignItems: "center", gap: 4 }}><MinusIcon /> SET</button>
                  )}
                </div>
              </div>

              {/* â”€â”€ NOTES â”€â”€ */}
              <div style={{ padding: "10px 16px 14px", borderTop: `1px solid ${T.borderSubtle}` }}>
                <div style={{ ...S.sectionLabel, color: T.textMuted, marginBottom: 6 }}>
                  <EditIcon /> NOTES
                </div>
                <textarea
                  value={ex.notes || ""}
                  onChange={e => updateField(exIdx, "notes", e.target.value)}
                  placeholder="Form cues, how it felt, weight adjustments..."
                  style={{
                    ...S.input,
                    minHeight: 50,
                    resize: "vertical",
                    fontSize: 12,
                    lineHeight: 1.5,
                    padding: "8px 10px",
                    borderColor: T.borderInput,
                  }}
                />
              </div>
            </div>
          );
        })}

        {/* â”€â”€ COOLDOWN NOTES â”€â”€ */}
        <div style={{ ...S.card, padding: 0, marginBottom: 16, borderColor: "#8b5cf622" }}>
          <div style={{ padding: "10px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", alignItems: "center", gap: 6 }}>
            <span style={{ fontSize: 11, color: "#8b5cf6" }}>â„</span>
            <span style={{ fontSize: 9, fontWeight: 700, color: "#8b5cf6", letterSpacing: 1.5 }}>COOLDOWN</span>
          </div>
          <div style={{ padding: "10px 16px" }}>
            <textarea
              value={activeWorkout.cooldownNotes || ""}
              onChange={e => setActiveWorkout({ ...activeWorkout, cooldownNotes: e.target.value })}
              placeholder="Stretching, foam rolling, mobility work..."
              style={{
                ...S.input,
                minHeight: 44,
                resize: "vertical",
                fontSize: 11,
                lineHeight: 1.6,
                padding: "8px 10px",
                borderColor: "#8b5cf615",
              }}
            />
          </div>
        </div>

        {/* â”€â”€ ADD EXERCISE MID-WORKOUT â”€â”€ */}
        {!showMidWorkoutPicker ? (
          <button onClick={() => setShowMidWorkoutPicker(true)}
            style={{ ...S.btnOutline("#0ea5e9"), marginBottom: 16, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>
            <PlusIcon /> ADD EXERCISE
          </button>
        ) : (
          <div style={{ ...S.card, padding: 0, marginBottom: 16, border: `1px solid #0ea5e933` }}>
            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1 }}>ADD EXERCISE</span>
              <button onClick={() => setShowMidWorkoutPicker(false)}
                style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}>
                <XIcon />
              </button>
            </div>
            <div style={{ maxHeight: 300, overflowY: "auto", padding: "8px 0" }}>
              {(() => {
                const currentIds = activeWorkout.exercises.map(e => e.exerciseId);
                const available = allExercises.filter(e => !currentIds.includes(e.id));
                const categories = [...new Set(available.map(e => e.category))];
                return categories.map(cat => {
                  const catExercises = available.filter(e => e.category === cat);
                  const catInfo = CATEGORY_COLORS[cat] || { accent: "#888", label: cat };
                  return (
                    <div key={cat} style={{ padding: "0 12px" }}>
                      <div style={{ ...S.tag(catInfo.accent), marginTop: 8, marginBottom: 4 }}>{catInfo.label}</div>
                      {catExercises.map(ex => (
                        <div key={ex.id} onClick={() => addExerciseMidWorkout(ex.id)}
                          style={{ padding: "8px 12px", cursor: "pointer", borderRadius: 6, display: "flex", justifyContent: "space-between", alignItems: "center",
                            transition: "background 0.1s" }}
                          onMouseOver={e => e.currentTarget.style.background = T.bgInset}
                          onMouseOut={e => e.currentTarget.style.background = "transparent"}>
                          <div>
                            <div style={{ fontSize: 12, fontWeight: 600, color: T.textStrong }}>{ex.name}</div>
                            <div style={{ fontSize: 9, color: T.textFaint }}>{ex.muscle}</div>
                          </div>
                          <span style={{ color: "#0ea5e9", fontSize: 9, flexShrink: 0 }}><PlusIcon /></span>
                        </div>
                      ))}
                    </div>
                  );
                });
              })()}
            </div>
          </div>
        )}

        <button style={S.btn("#22c55e")} onClick={() => {
          if (editingLogIdx === null && activeWorkout) {
            // Capture for template prompt before saveWorkout clears it
            const capturedName = activeWorkout.name;
            const capturedIds = activeWorkout.exercises.map(e => e.exerciseId);
            const capturedLocation = activeWorkout.location || "";
            const capturedConfigs = activeWorkout.exercises.map(e => ({
              exerciseId: e.exerciseId,
              targetWeight: e.workingWeight || 0,
              warmupWeight: e.warmupWeight || 0,
              targetSets: (e.workingSets || []).length,
              targetReps: 12,
              notes: e.notes || "",
            }));
            saveWorkout();
            // Check if a template with these exact exercises already exists
            const existing = (data.templates || []).find(t =>
              t.exerciseIds.length === capturedIds.length && t.exerciseIds.every((id, i) => id === capturedIds[i])
            );
            if (!existing) {
              setTemplateName(capturedName);
              setShowSaveTemplate({ name: capturedName, exerciseIds: capturedIds, location: capturedLocation, exerciseConfigs: capturedConfigs, warmupNotes: activeWorkout.warmupNotes, cooldownNotes: activeWorkout.cooldownNotes });
            }
          } else {
            saveWorkout();
          }
        }}>
          <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><CheckIcon /> {editingLogIdx !== null ? "SAVE CHANGES" : "FINISH WORKOUT"}</span>
        </button>
        <button onClick={() => { setActiveWorkout(null); setEditingLogIdx(null); setView(editingLogIdx !== null ? "history" : "dashboard"); }} style={{ ...S.btnOutline("#333"), marginTop: 40, fontSize: 9, opacity: 0.5 }}>
          {editingLogIdx !== null ? "CANCEL EDIT" : "DISCARD"}
        </button>
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROGRESS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderProgress = () => {
    const exercisesWithHistory = allExercises
      .map(ex => {
        const logs = data.workoutLogs.map(log => {
          const found = log.exercises.find(e => e.exerciseId === ex.id);
          if (!found) return null;
          const maxSetWeight = found.workingSets ? Math.max(found.workingWeight || 0, ...found.workingSets.map(s => (s.weight && s.completed) ? s.weight : 0)) : (found.workingWeight || found.weight || 0);
          return { date: log.date, warmupWeight: found.warmupWeight || 0, workingWeight: maxSetWeight };
        }).filter(Boolean);
        return { ...ex, history: logs };
      })
      .filter(e => e.history.length > 0);

    return (
      <div>
        <div style={{ ...S.sectionLabel, color: T.textMuted, marginBottom: 14 }}>Exercise Progress</div>
        {exercisesWithHistory.length === 0 ? (
          <div style={{ ...S.card, textAlign: "center", padding: 30, color: T.textFaint }}>
            <div style={{ fontSize: 12 }}>No workout data yet</div>
            <div style={{ fontSize: 10, marginTop: 4 }}>Complete your first workout to see progress</div>
          </div>
        ) : exercisesWithHistory.map(ex => {
          const catInfo = CATEGORY_COLORS[ex.category] || { accent: "#888" };
          const workingWeights = ex.history.map(h => h.workingWeight).filter(w => w > 0);
          const pr = workingWeights.length > 0 ? Math.max(...workingWeights) : 0;
          const latest = workingWeights[workingWeights.length - 1] || 0;
          const first = workingWeights[0] || 0;
          const change = first > 0 ? Math.round((latest - first) / first * 100) : 0;
          const suggestion = getProgressionSuggestion(ex.id, data.workoutLogs);

          return (
            <div key={ex.id} style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                <div>
                  <div style={S.tag(catInfo.accent)}>{CATEGORY_COLORS[ex.category]?.label}</div>
                  <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong, marginTop: 6 }}>{ex.name}</div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontSize: 17, fontWeight: 800, color: "#e94560" }}>{pr} lb</div>
                  <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 1 }}>WORKING PR</div>
                </div>
              </div>

              {/* History bars */}
              <div style={{ display: "flex", gap: 3, marginTop: 14, alignItems: "flex-end", height: 36 }}>
                {ex.history.map((h, i) => {
                  const maxW = Math.max(...ex.history.map(x => x.workingWeight));
                  const pct = maxW > 0 ? (h.workingWeight / maxW * 100) : 0;
                  return (
                    <div key={i} style={{ flex: 1, maxWidth: 28, display: "flex", flexDirection: "column", alignItems: "center", gap: 2 }}>
                      <div style={{ width: "100%", height: `${Math.max(pct, 8)}%`, minHeight: 3, background: h.workingWeight === pr ? "#e94560" : catInfo.accent + "50", borderRadius: 2 }} />
                    </div>
                  );
                })}
              </div>
              <div style={{ display: "flex", gap: 3, marginTop: 2 }}>
                {ex.history.map((h, i) => (
                  <div key={i} style={{ flex: 1, maxWidth: 28, textAlign: "center", fontSize: 7, color: T.textFaint }}>{h.workingWeight}</div>
                ))}
              </div>

              {/* Warmup vs Working comparison */}
              <div style={{ display: "flex", justifyContent: "space-between", marginTop: 14, paddingTop: 10, borderTop: `1px solid ${T.borderSubtle}`, flexWrap: "wrap", gap: 6 }}>
                <div>
                  <span style={{ fontSize: 9, color: T.textMuted }}>Warmup: </span>
                  <span style={{ fontSize: 11, fontWeight: 600, color: "#f59e0b" }}>{ex.history[ex.history.length - 1]?.warmupWeight || "â€”"} lb</span>
                </div>
                <div>
                  <span style={{ fontSize: 9, color: T.textMuted }}>Change: </span>
                  <span style={{ fontSize: 11, fontWeight: 700, color: change > 0 ? "#22c55e" : change < 0 ? "#e94560" : "#444" }}>
                    {change > 0 ? "+" : ""}{change}%
                  </span>
                </div>
                {suggestion && (
                  <div>
                    <span style={{ fontSize: 9, color: T.textMuted }}>Next: </span>
                    <span style={{ fontSize: 11, fontWeight: 700, color: "#f59e0b" }}>{suggestion} lb</span>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PR BOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderPRs = () => {
    const prs = allExercises.map(ex => {
      const logs = data.workoutLogs.map(log => {
        const found = log.exercises.find(e => e.exerciseId === ex.id);
        if (!found) return null;
        const maxSetWeight = found.workingSets ? Math.max(found.workingWeight || 0, ...found.workingSets.map(s => (s.weight && s.completed) ? s.weight : 0)) : (found.workingWeight || found.weight || 0);
        return { date: log.date, weight: maxSetWeight };
      }).filter(Boolean).filter(l => l.weight > 0);
      if (logs.length === 0) return null;
      const best = logs.reduce((max, l) => l.weight > max.weight ? l : max, logs[0]);
      return { ...ex, prWeight: best.weight, prDate: best.date, totalSessions: logs.length };
    }).filter(Boolean).sort((a, b) => b.prWeight - a.prWeight);

    const medals = ["#f59e0b", "#a0a0b0", "#cd7f32"];

    return (
      <div>
        <div style={{ ...S.sectionLabel, color: T.textMuted, marginBottom: 14 }}>Personal Records</div>
        {prs.length === 0 ? (
          <div style={{ ...S.card, textAlign: "center", padding: 30, color: T.textFaint }}>
            <div style={{ fontSize: 12 }}>No PRs yet</div>
            <div style={{ fontSize: 10, marginTop: 4 }}>Log your first workout to start tracking</div>
          </div>
        ) : prs.map((pr, i) => {
          const catInfo = CATEGORY_COLORS[pr.category] || { accent: "#888" };
          const medalColor = medals[i] || "#333";
          return (
            <div key={pr.id} style={{ ...S.card, display: "flex", alignItems: "center", gap: 12, padding: "12px 14px" }}>
              <div style={{
                width: 34, height: 34, borderRadius: 8, flexShrink: 0,
                background: i < 3 ? medalColor + "12" : T.bgInset,
                border: `1px solid ${i < 3 ? medalColor + "44" : T.borderInput}`,
                display: "flex", alignItems: "center", justifyContent: "center",
                fontSize: 13, fontWeight: 800, color: i < 3 ? medalColor : "#444",
              }}>{i + 1}</div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: T.textStrong, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{pr.name}</div>
                <div style={{ fontSize: 9, color: T.textFaint, marginTop: 1 }}>{formatDate(pr.prDate)} Â· {pr.totalSessions} session{pr.totalSessions > 1 ? "s" : ""}</div>
              </div>
              <div style={{ textAlign: "right", flexShrink: 0 }}>
                <div style={{ fontSize: 17, fontWeight: 800, color: catInfo.accent }}>{pr.prWeight}</div>
                <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 0.5 }}>LB</div>
              </div>
            </div>
          );
        })}
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXERCISE LIBRARY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const addExercise = async () => {
    if (!newExercise.name.trim()) return;
    const id = "custom-" + Date.now();
    const exercise = { ...newExercise, id, name: newExercise.name.trim(), muscle: newExercise.muscle.trim(), videoUrl: newExercise.videoUrl.trim() };

    if (shareToLibrary) {
      // Save to shared Firestore collection
      try {
        const sharedDoc = { ...exercise, addedBy: user.uid, addedByName: user.name || "Unknown", addedAt: new Date().toISOString() };
        await db.collection("shared").doc("exercises").collection("library").doc(id).set(sharedDoc);
        setSharedExercises(prev => [...prev, sharedDoc]);
      } catch (e) { console.error("Share failed:", e); }
    } else {
      // Save only to personal custom exercises
      persist({ ...data, customExercises: [...(data.customExercises || []), exercise] });
    }

    setNewExercise({ name: "", category: "posterior", muscle: "", videoUrl: "" });
    setShareToLibrary(true);
    setShowAddExercise(false);
  };

  const updateExerciseVideo = (exerciseId, newUrl) => {
    const isCustom = (data.customExercises || []).find(e => e.id === exerciseId);
    if (isCustom) {
      persist({ ...data, customExercises: data.customExercises.map(e => e.id === exerciseId ? { ...e, videoUrl: newUrl } : e) });
    } else {
      const existing = (data.videoOverrides || {});
      persist({ ...data, videoOverrides: { ...existing, [exerciseId]: newUrl } });
    }
    setEditingExercise(null);
  };

  const updateCustomExercise = (exerciseId, updates) => {
    persist({ ...data, customExercises: (data.customExercises || []).map(e => e.id === exerciseId ? { ...e, ...updates } : e) });
    setEditingExercise(null);
  };

  const deleteCustomExercise = (exerciseId) => {
    persist({ ...data, customExercises: (data.customExercises || []).filter(e => e.id !== exerciseId) });
  };

  const deleteSharedExercise = async (exerciseId) => {
    try {
      await db.collection("shared").doc("exercises").collection("library").doc(exerciseId).delete();
      setSharedExercises(prev => prev.filter(e => e.id !== exerciseId));
    } catch (e) { console.error("Delete shared exercise failed:", e); }
  };

  // â”€â”€â”€ Template helpers â”€â”€â”€
  const saveAsTemplate = (name, exerciseIds, location, exerciseConfigs, warmupNotes, cooldownNotes) => {
    const template = {
      id: "tpl-" + Date.now(),
      name: name.trim(),
      exerciseIds,
      exerciseConfigs: exerciseConfigs || [],
      location: location || "",
      warmupNotes: warmupNotes || "",
      cooldownNotes: cooldownNotes || "",
      createdAt: new Date().toISOString(),
    };
    persist({ ...data, templates: [...(data.templates || []), template] });
  };

  const deleteTemplate = (templateId) => {
    persist({ ...data, templates: (data.templates || []).filter(t => t.id !== templateId) });
    if (editingTemplate?.id === templateId) setEditingTemplate(null);
  };

  const openTemplateEditor = (tpl) => {
    setTplName(tpl.name);
    setTplWarmup(tpl.warmupNotes || "");
    setTplCooldown(tpl.cooldownNotes || "");
    setTplExerciseConfigs(tpl.exerciseConfigs || tpl.exerciseIds.map(id => ({
      exerciseId: id,
      targetWeight: 0,
      warmupWeight: 0,
      targetSets: 3,
      targetReps: 12,
      notes: "",
    })));
    setEditingTemplate(tpl);
  };

  const updateTemplate = () => {
    if (!editingTemplate) return;
    const exerciseIds = tplExerciseConfigs.map(c => c.exerciseId);

    let finalName = tplName.trim();
    if (!finalName) {
      const cats = [...new Set(exerciseIds.map(id => {
        const ex = allExercises.find(e => e.id === id);
        return ex ? (CATEGORY_COLORS[ex.category]?.label || ex.category) : null;
      }).filter(Boolean))];
      finalName = cats.join(" + ") || "Workout";
    }

    const updated = {
      ...editingTemplate,
      name: finalName,
      exerciseIds,
      exerciseConfigs: tplExerciseConfigs,
      warmupNotes: tplWarmup,
      cooldownNotes: tplCooldown,
    };
    const templates = (data.templates || []).map(t => t.id === editingTemplate.id ? updated : t);
    persist({ ...data, templates });
    setEditingTemplate(null);
    setTplName("");
    setTplExerciseConfigs([]);
    setTplWarmup("");
    setTplCooldown("");
  };

  const startFromTemplate = (template) => {
    if (activeWorkout && activeWorkout.exercises) {
      if (!confirm("You have a workout in progress (" + activeWorkout.name + "). Starting a new one will replace it. Continue?")) return;
    }
    const ids = template.exerciseIds.filter(id => allExercises.find(e => e.id === id));
    const configs = template.exerciseConfigs || [];

    // Build exercises with template weights pre-loaded
    const exercises = ids.map(id => {
      const ex = allExercises.find(e => e.id === id);
      const config = configs.find(c => c.exerciseId === id);
      const isCardio = ex.isCardio || ex.category === "cardio";

      if (isCardio) {
        const lastCardio = getLastCardioStats(id, data.workoutLogs);
        return {
          exerciseId: id, name: ex.name, category: ex.category, isCardio: true,
          duration: lastCardio?.duration || 0, distance: lastCardio?.distance || 0,
          calories: lastCardio?.calories || 0, avgHeartRate: lastCardio?.avgHeartRate || 0,
          notes: config?.notes || "", completed: false,
        };
      }

      const lastWorking = getLastWorkingWeight(id, data.workoutLogs);
      const lastWarmup = getLastWarmupWeight(id, data.workoutLogs);
      const suggestion = getProgressionSuggestion(id, data.workoutLogs);
      const pr = getPR(id, data.workoutLogs);

      const workingWeight = config?.targetWeight || lastWorking || 0;
      const warmupWeight = config?.warmupWeight || lastWarmup || (workingWeight > 0 ? Math.round(workingWeight * 0.5 / 5) * 5 : 0);
      const numSets = config?.targetSets || 3;
      const targetReps = config?.targetReps || 12;

      return {
        exerciseId: id,
        name: ex.name,
        category: ex.category,
        warmupWeight,
        workingWeight,
        warmupSets: [{ reps: 0, completed: false }],
        workingSets: Array.from({ length: numSets }, () => ({ reps: 0, completed: false, weight: null })),
        notes: config?.notes || "",
        pr,
        suggestion,
        lastWorking,
      };
    });

    const selectedDate = new Date(workoutDate + "T12:00:00");
    setActiveWorkout({ date: selectedDate.toISOString(), name: template.name, location: template.location || workoutLocation || "", exercises, warmupNotes: template.warmupNotes || "", cooldownNotes: template.cooldownNotes || "" });
    setView("active");
  };

  // â”€â”€â”€ Planned Workouts â”€â”€â”€
  const savePlannedWorkout = (date, name) => {
    const exerciseIds = planExerciseConfigs.map(c => c.exerciseId);

    // Auto-generate name from categories if empty
    let finalName = name.trim();
    if (!finalName) {
      const cats = [...new Set(exerciseIds.map(id => {
        const ex = allExercises.find(e => e.id === id);
        return ex ? (CATEGORY_COLORS[ex.category]?.label || ex.category) : null;
      }).filter(Boolean))];
      finalName = cats.join(" + ") || "Workout";
    }

    const planned = {
      id: Date.now().toString(),
      date,
      name: finalName,
      exerciseIds,
      exerciseConfigs: planExerciseConfigs,
      warmupNotes: planWarmup,
      cooldownNotes: planCooldown,
      createdAt: new Date().toISOString(),
    };
    const existing = data.plannedWorkouts || [];
    persist({ ...data, plannedWorkouts: [...existing, planned] });
    setPlanningDate(null);
    setPlanExerciseConfigs([]);
    setPlanName("");
    setPlanWarmup("");
    setPlanCooldown("");
  };

  const startPlannedWorkout = (planned) => {
    // Reuse startFromTemplate logic since data shape is the same
    const template = { ...planned, location: "" };
    startFromTemplate(template);
    // Add warmup/cooldown notes to the active workout
    setActiveWorkout(prev => prev ? { ...prev, warmupNotes: planned.warmupNotes || "", cooldownNotes: planned.cooldownNotes || "" } : prev);
    // Remove the planned workout since it's now active
    const remaining = (data.plannedWorkouts || []).filter(p => p.id !== planned.id);
    persist({ ...data, plannedWorkouts: remaining });
  };

  const deletePlannedWorkout = (id) => {
    const remaining = (data.plannedWorkouts || []).filter(p => p.id !== id);
    persist({ ...data, plannedWorkouts: remaining });
    if (editingPlan?.id === id) setEditingPlan(null);
  };

  const duplicatePlannedWorkout = (plan) => {
    const newDate = prompt("Copy this workout to which date? (YYYY-MM-DD)", "");
    if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) return;
    const copy = {
      ...plan,
      id: Date.now().toString(),
      date: newDate,
      name: plan.name,
    };
    persist({ ...data, plannedWorkouts: [...(data.plannedWorkouts || []), copy] });
  };

  const convertLogToPlannedWorkout = (log, targetDate) => {
    const newDate = targetDate || prompt("Plan this workout for which date? (YYYY-MM-DD)", "");
    if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) return;
    const exerciseConfigs = (log.exercises || []).map(ex => ({
      exerciseId: ex.exerciseId,
      targetWeight: ex.workingWeight || 0,
      warmupWeight: ex.warmupWeight || 0,
      targetSets: ex.isCardio ? 0 : (ex.workingSets || []).length,
      targetReps: ex.isCardio ? 0 : Math.max(...(ex.workingSets || []).map(s => s.reps || 0), 0),
    }));
    const planned = {
      id: Date.now().toString(),
      date: newDate,
      name: log.name || "Workout",
      exerciseIds: (log.exercises || []).map(e => e.exerciseId),
      exerciseConfigs,
      warmupNotes: log.warmupNotes || "",
      cooldownNotes: log.cooldownNotes || "",
    };
    persist({ ...data, plannedWorkouts: [...(data.plannedWorkouts || []), planned] });
  };

  const openPlanEditor = (plan) => {
    setPlanningDate(plan.date);
    setPlanName(plan.name);
    setPlanWarmup(plan.warmupNotes || "");
    setPlanCooldown(plan.cooldownNotes || "");
    setPlanExerciseConfigs(plan.exerciseConfigs || plan.exerciseIds.map(id => ({
      exerciseId: id,
      targetWeight: 0,
      warmupWeight: 0,
      targetSets: 3,
      targetReps: 12,
    })));
    setEditingPlan(plan);
    setView("dashboard");
  };

  const updatePlannedWorkout = () => {
    if (!editingPlan) return;
    const exerciseIds = planExerciseConfigs.map(c => c.exerciseId);

    let finalName = planName.trim();
    if (!finalName) {
      const cats = [...new Set(exerciseIds.map(id => {
        const ex = allExercises.find(e => e.id === id);
        return ex ? (CATEGORY_COLORS[ex.category]?.label || ex.category) : null;
      }).filter(Boolean))];
      finalName = cats.join(" + ") || "Workout";
    }

    const updated = {
      ...editingPlan,
      name: finalName,
      exerciseIds,
      exerciseConfigs: planExerciseConfigs,
      warmupNotes: planWarmup,
      cooldownNotes: planCooldown,
    };
    const remaining = (data.plannedWorkouts || []).map(p => p.id === editingPlan.id ? updated : p);
    persist({ ...data, plannedWorkouts: remaining });
    setEditingPlan(null);
    setPlanningDate(null);
    setPlanExerciseConfigs([]);
    setPlanName("");
    setPlanWarmup("");
    setPlanCooldown("");
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WORKOUT HISTORY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderHistory = () => {
    const logs = [...data.workoutLogs].map((log, idx) => ({ ...log, _idx: idx })).reverse();
    const formatFullDate = (d) => new Date(d).toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" });

    const deleteWorkout = (idx) => {
      const updated = { ...data, workoutLogs: data.workoutLogs.filter((_, i) => i !== idx) };
      persist(updated);
      setExpandedLogIdx(null);
    };

    const editWorkout = (idx) => {
      const log = data.workoutLogs[idx];
      setActiveWorkout({ ...log });
      setEditingLogIdx(idx);
      setView("active");
    };

    const exportWorkout = (log) => {
      const fullDate = new Date(log.date).toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" });
      let text = `${log.name}\n${fullDate}\n`;
      if (log.location) text += `ðŸ“ ${log.location}\n`;
      text += `${"â”€".repeat(30)}\n`;
      if (log.warmupNotes) text += `\nWarmup: ${log.warmupNotes}\n`;
      text += `\n`;

      log.exercises.forEach((ex, i) => {
        const catLabel = (CATEGORY_COLORS[ex.category] || {}).label || ex.category;
        text += `${i + 1}. ${ex.name} [${catLabel}]\n`;

        if (ex.isCardio) {
          const stats = [];
          if (ex.duration > 0) stats.push(`${ex.duration} min`);
          if (ex.distance > 0) stats.push(`${ex.distance} mi`);
          if (ex.calories > 0) stats.push(`${ex.calories} cal`);
          if (ex.avgHeartRate > 0) stats.push(`${ex.avgHeartRate} avg bpm`);
          if (stats.length > 0) text += `   ${stats.join(" Â· ")}\n`;
        } else {
          if ((ex.warmupSets || []).length > 0 && ex.warmupWeight > 0) {
            const warmupReps = (ex.warmupSets || []).filter(s => s.completed).map(s => s.reps);
            if (warmupReps.length > 0) text += `   Warmup: ${ex.warmupWeight}lb Ã— ${warmupReps.join(", ")} reps\n`;
          }

          const workingSets = (ex.workingSets || ex.sets || []).filter(s => s.completed);
          if (workingSets.length > 0) {
            const setStrs = workingSets.map(s => {
              const w = s.weight || ex.workingWeight || 0;
              return `${w}lb Ã— ${s.reps}`;
            });
            text += `   Working: ${setStrs.join(" | ")}\n`;
          }

          const skipped = (ex.workingSets || ex.sets || []).filter(s => !s.completed).length;
          if (skipped > 0) text += `   (${skipped} set${skipped > 1 ? "s" : ""} skipped)\n`;
        }

        if (ex.notes) text += `   Notes: ${ex.notes}\n`;
        text += `\n`;
      });

      text += `${"â”€".repeat(30)}\n`;
      if (log.cooldownNotes) text += `Cooldown: ${log.cooldownNotes}\n`;
      const totalWorking = log.exercises.reduce((s, ex) => s + (ex.workingSets || ex.sets || []).filter(s => s.completed).length, 0);
      text += `${log.exercises.length} exercises Â· ${totalWorking} working sets\n`;
      text += `Tracked with GetNerdyIn30.com`;

      return text;
    };

    const copyWorkout = async (log) => {
      const text = exportWorkout(log);
      try {
        await navigator.clipboard.writeText(text);
        setCopiedIdx(log._idx);
        setTimeout(() => setCopiedIdx(null), 2000);
      } catch {
        // Fallback for older browsers
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        setCopiedIdx(log._idx);
        setTimeout(() => setCopiedIdx(null), 2000);
      }
    };

    const shareWorkout = async (log) => {
      const text = exportWorkout(log);
      if (navigator.share) {
        try {
          await navigator.share({ title: log.name, text });
        } catch {}
      } else {
        copyWorkout(log);
      }
    };

    return (
      <div>
        <div style={{ ...S.sectionLabel, color: T.textMuted, marginBottom: 14 }}>
          <HistoryIcon /> WORKOUT HISTORY ({logs.length})
        </div>

        {logs.length === 0 ? (
          <div style={{ ...S.card, textAlign: "center", padding: 30, color: T.textFaint }}>
            <div style={{ fontSize: 12 }}>No workouts logged yet</div>
            <div style={{ fontSize: 10, marginTop: 4 }}>Complete your first workout to see it here</div>
          </div>
        ) : logs.map((log) => {
          const isExpanded = expandedLogIdx === log._idx;
          const totalWorkingSets = log.exercises.reduce((s, ex) => s + (ex.workingSets || ex.sets || []).filter(set => set.completed).length, 0);
          const totalWarmupSets = log.exercises.reduce((s, ex) => s + (ex.warmupSets || []).filter(set => set.completed).length, 0);

          return (
            <div key={log._idx} style={{ ...S.card, padding: 0, marginBottom: 8, overflow: "hidden" }}>
              {/* Header - always visible */}
              <div onClick={() => setExpandedLogIdx(isExpanded ? null : log._idx)}
                style={{ padding: "14px 16px", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div>
                  <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong }}>{log.name}</div>
                  <div style={{ fontSize: 10, color: T.textMuted, marginTop: 2 }}>{formatFullDate(log.date)}</div>
                  {log.location && (
                    <div style={{ display: "flex", alignItems: "center", gap: 4, marginTop: 3 }}>
                      <span style={{ color: "#0ea5e9" }}><MapPinIcon /></span>
                      <span style={{ fontSize: 9, color: "#0ea5e9" }}>{log.location}</span>
                    </div>
                  )}
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: "#e94560" }}>{log.exercises.length} exercises</div>
                    <div style={{ fontSize: 9, color: T.textMuted }}>{totalWorkingSets} sets</div>
                  </div>
                  <span style={{ color: T.textMuted }}><ChevronIcon down={isExpanded} /></span>
                </div>
              </div>

              {/* Expanded detail */}
              {isExpanded && (
                <div style={{ borderTop: `1px solid ${T.borderSubtle}` }}>
                  {/* Warmup notes in history */}
                  {log.warmupNotes && (
                    <div style={{ padding: "10px 16px", borderBottom: `1px solid ${T.borderSubtle}`, background: T.bgInset }}>
                      <div style={{ fontSize: 8, fontWeight: 700, color: "#f59e0b", letterSpacing: 1.5, marginBottom: 4 }}>WARMUP</div>
                      <div style={{ fontSize: 11, color: T.textMuted, lineHeight: 1.5 }}>{log.warmupNotes}</div>
                    </div>
                  )}

                  {log.exercises.map((ex, exIdx) => {
                    const catInfo = CATEGORY_COLORS[ex.category] || { accent: "#888", label: ex.category };

                    // â”€â”€ CARDIO in history â”€â”€
                    if (ex.isCardio) {
                      return (
                        <div key={exIdx} style={{ padding: "12px 16px", borderBottom: exIdx < log.exercises.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                          <div style={S.tag(catInfo.accent)}>{catInfo.label}</div>
                          <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong, marginTop: 4, marginBottom: 8 }}>{ex.name}</div>
                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 8 }}>
                            {ex.duration > 0 && (
                              <div style={{ textAlign: "center" }}>
                                <div style={{ fontSize: 16, fontWeight: 800, color: "#ff6b35" }}>{ex.duration}</div>
                                <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5 }}>MIN</div>
                              </div>
                            )}
                            {ex.distance > 0 && (
                              <div style={{ textAlign: "center" }}>
                                <div style={{ fontSize: 16, fontWeight: 800, color: "#ff6b35" }}>{ex.distance}</div>
                                <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5 }}>MI</div>
                              </div>
                            )}
                            {ex.calories > 0 && (
                              <div style={{ textAlign: "center" }}>
                                <div style={{ fontSize: 16, fontWeight: 800, color: "#ff6b35" }}>{ex.calories}</div>
                                <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5 }}>CAL</div>
                              </div>
                            )}
                            {ex.avgHeartRate > 0 && (
                              <div style={{ textAlign: "center" }}>
                                <div style={{ fontSize: 16, fontWeight: 800, color: "#e94560" }}>{ex.avgHeartRate}</div>
                                <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5 }}>BPM</div>
                              </div>
                            )}
                          </div>
                          {ex.notes && (
                            <div style={{ marginTop: 8, padding: "6px 10px", background: T.bgInset, borderRadius: 6, fontSize: 10, color: T.textMuted, lineHeight: 1.5, fontStyle: "italic" }}>
                              {ex.notes}
                            </div>
                          )}
                        </div>
                      );
                    }

                    // â”€â”€ STRENGTH in history â”€â”€
                    const maxSetWeight = Math.max(
                      ex.workingWeight || 0,
                      ...(ex.workingSets || ex.sets || []).map(s => s.weight || 0)
                    );

                    return (
                      <div key={exIdx} style={{ padding: "12px 16px", borderBottom: exIdx < log.exercises.length - 1 ? `1px solid ${T.borderSubtle}` : "none" }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8 }}>
                          <div>
                            <div style={S.tag(catInfo.accent)}>{catInfo.label}</div>
                            <div style={{ fontSize: 13, fontWeight: 700, color: T.textStrong, marginTop: 4 }}>{ex.name}</div>
                          </div>
                          <div style={{ textAlign: "right" }}>
                            <div style={{ fontSize: 16, fontWeight: 800, color: catInfo.accent }}>{maxSetWeight}</div>
                            <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 0.5 }}>LB MAX</div>
                          </div>
                        </div>

                        {/* Warmup summary */}
                        {(ex.warmupSets || []).length > 0 && ex.warmupWeight > 0 && (
                          <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 4 }}>
                            <span style={{ fontSize: 9, color: "#f59e0b", fontWeight: 600 }}>WARMUP</span>
                            <span style={{ fontSize: 10, color: T.textMuted }}>
                              {ex.warmupWeight} lb Ã— {(ex.warmupSets || []).filter(s => s.completed).map(s => s.reps).join(", ")} reps
                            </span>
                          </div>
                        )}

                        {/* Working sets detail */}
                        <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 4 }}>
                          <span style={{ fontSize: 9, color: "#22c55e", fontWeight: 600 }}>WORKING</span>
                          <span style={{ fontSize: 10, color: T.textMuted }}>
                            {(ex.workingSets || ex.sets || []).filter(s => s.completed).map(s => {
                              const w = s.weight || ex.workingWeight || 0;
                              return `${w}lb Ã— ${s.reps}`;
                            }).join(" Â· ")}
                          </span>
                        </div>
                        {(ex.workingSets || ex.sets || []).filter(s => !s.completed).length > 0 && (
                          <div style={{ fontSize: 9, color: T.textFaint, fontStyle: "italic" }}>
                            {(ex.workingSets || ex.sets || []).filter(s => !s.completed).length} set(s) skipped
                          </div>
                        )}

                        {/* Notes */}
                        {ex.notes && (
                          <div style={{ marginTop: 6, padding: "6px 10px", background: T.bgInset, borderRadius: 6, fontSize: 10, color: T.textMuted, lineHeight: 1.5, fontStyle: "italic" }}>
                            {ex.notes}
                          </div>
                        )}
                      </div>
                    );
                  })}

                  {/* Cooldown notes in history */}
                  {log.cooldownNotes && (
                    <div style={{ padding: "10px 16px", borderTop: `1px solid ${T.borderSubtle}`, background: T.bgInset }}>
                      <div style={{ fontSize: 8, fontWeight: 700, color: "#8b5cf6", letterSpacing: 1.5, marginBottom: 4 }}>COOLDOWN</div>
                      <div style={{ fontSize: 11, color: T.textMuted, lineHeight: 1.5 }}>{log.cooldownNotes}</div>
                    </div>
                  )}

                  {/* Actions */}
                  <div style={{ padding: "10px 16px", borderTop: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <div style={{ display: "flex", gap: 12 }}>
                      <button onClick={(e) => { e.stopPropagation(); editWorkout(log._idx); }}
                        style={{ background: "none", border: "none", color: "#0ea5e9", cursor: "pointer", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, display: "flex", alignItems: "center", gap: 4 }}>
                        <EditIcon /> EDIT
                      </button>
                      <button onClick={(e) => { e.stopPropagation(); shareWorkout(log); }}
                        style={{ background: "none", border: "none", color: "#22c55e", cursor: "pointer", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, display: "flex", alignItems: "center", gap: 4 }}>
                        <CopyIcon /> {copiedIdx === log._idx ? "COPIED âœ“" : "SHARE"}
                      </button>
                      <button onClick={(e) => { e.stopPropagation(); convertLogToPlannedWorkout(log); }}
                        style={{ background: "none", border: "none", color: "#f59e0b", cursor: "pointer", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, display: "flex", alignItems: "center", gap: 4 }}>
                        <CalendarIcon /> PLAN AGAIN
                      </button>
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); if(confirm("Delete this workout from " + formatDate(log.date) + "?")) deleteWorkout(log._idx); }}
                      style={{ background: "none", border: "none", color: "#e94560", cursor: "pointer", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, display: "flex", alignItems: "center", gap: 4 }}>
                      <TrashIcon /> DELETE
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>
    );
  };

  const renderLibrary = () => {
    const categories = Object.keys(CATEGORY_COLORS);
    const customIds = new Set((data.customExercises || []).map(e => e.id));
    const filtered = allExercises.filter(ex =>
      librarySearch === "" ||
      ex.name.toLowerCase().includes(librarySearch.toLowerCase()) ||
      ex.muscle.toLowerCase().includes(librarySearch.toLowerCase())
    );

    return (
      <div>
        <div style={{ marginBottom: 14 }}>
          <input style={S.input} placeholder="Search exercises..." value={librarySearch} onChange={e => setLibrarySearch(e.target.value)} />
        </div>

        {!showAddExercise ? (
          <button style={S.btn("#0ea5e9")} onClick={() => setShowAddExercise(true)}>
            <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><PlusIcon /> ADD NEW EXERCISE</span>
          </button>
        ) : (
          <div style={{ ...S.card, borderColor: "#0ea5e933", marginBottom: 16 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <div style={{ ...S.sectionLabel, color: "#0ea5e9", marginBottom: 0 }}>NEW EXERCISE</div>
              <button onClick={() => setShowAddExercise(false)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer" }}><XIcon /></button>
            </div>

            <div style={{ marginBottom: 10 }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>NAME *</div>
              <input style={S.input} placeholder="e.g. Dumbbell Curl" value={newExercise.name} onChange={e => setNewExercise({ ...newExercise, name: e.target.value })} />
            </div>

            <div style={{ marginBottom: 10 }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>CATEGORY</div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                {categories.map(cat => {
                  const catInfo = CATEGORY_COLORS[cat];
                  const isSel = newExercise.category === cat;
                  return (
                    <button key={cat} onClick={() => setNewExercise({ ...newExercise, category: cat })}
                      style={{ padding: "4px 10px", borderRadius: 5, fontSize: 9, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", cursor: "pointer",
                        fontFamily: "'JetBrains Mono', monospace",
                        background: isSel ? catInfo.accent + "20" : T.inputBg,
                        color: isSel ? catInfo.accent : T.textMuted,
                        border: `1px solid ${isSel ? catInfo.accent + "66" : T.borderInput}`,
                      }}>{catInfo.label}</button>
                  );
                })}
              </div>
            </div>

            <div style={{ marginBottom: 10 }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>MUSCLE GROUP</div>
              <input style={S.input} placeholder="e.g. Biceps" value={newExercise.muscle} onChange={e => setNewExercise({ ...newExercise, muscle: e.target.value })} />
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>VIDEO / HOW-TO LINK</div>
              <input style={S.input} placeholder="https://youtube.com/watch?v=..." value={newExercise.videoUrl} onChange={e => setNewExercise({ ...newExercise, videoUrl: e.target.value })} />
              <div style={{ fontSize: 8, color: T.textFaint, marginTop: 3 }}>YouTube, Muscle & Strength, or any URL</div>
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 12px", background: shareToLibrary ? (dark ? "#22c55e10" : "#22c55e12") : T.bgInset, borderRadius: 8, border: `1px solid ${shareToLibrary ? "#22c55e33" : T.borderInput}`, cursor: "pointer" }}
                onClick={() => setShareToLibrary(!shareToLibrary)}>
                <div style={{ width: 20, height: 20, borderRadius: 5, border: `2px solid ${shareToLibrary ? "#22c55e" : T.borderInput}`, background: shareToLibrary ? "#22c55e20" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#22c55e", flexShrink: 0 }}>
                  {shareToLibrary && <CheckIcon />}
                </div>
                <div>
                  <div style={{ fontSize: 11, fontWeight: 600, color: shareToLibrary ? "#22c55e" : T.textMuted }}>Share with everyone</div>
                  <div style={{ fontSize: 8, color: T.textFaint, marginTop: 1 }}>All users will see this exercise in their library</div>
                </div>
              </div>
            </div>

            <button style={S.btn("#0ea5e9")} onClick={addExercise}>
              <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><CheckIcon /> SAVE EXERCISE</span>
            </button>
          </div>
        )}

        <div style={{ marginTop: 20 }}>
          {categories.map(cat => {
            const catInfo = CATEGORY_COLORS[cat];
            const catExercises = filtered.filter(e => e.category === cat);
            if (catExercises.length === 0) return null;

            return (
              <div key={cat} style={{ marginBottom: 16 }}>
                <div style={S.tag(catInfo.accent)}>{catInfo.label} ({catExercises.length})</div>

                {catExercises.map(ex => {
                  const isCustom = customIds.has(ex.id);
                  const sharedEx = sharedExercises.find(s => s.id === ex.id);
                  const isShared = !!sharedEx;
                  const isOwnShared = isShared && sharedEx.addedBy === user.uid;
                  const isAdmin = user.uid === "otHWKPN34YR5SuKN9pS4jzycM1I2";
                  const canDeleteShared = isShared && (isOwnShared || isAdmin);
                  const videoUrl = getVideoUrl(ex);
                  const pr = getPR(ex.id, data.workoutLogs);
                  const isEditing = editingExercise === ex.id;

                  if (isEditing) {
                    const editEx = isCustom ? (data.customExercises || []).find(e => e.id === ex.id) : ex;
                    return (
                      <div key={ex.id} style={{ ...S.card, marginBottom: 4, borderColor: "#0ea5e944" }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: T.textStrong }}>{ex.name}</div>
                          <button onClick={() => setEditingExercise(null)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer" }}><XIcon /></button>
                        </div>

                        {isCustom && (
                          <>
                            <div style={{ marginBottom: 8 }}>
                              <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 1, marginBottom: 3 }}>NAME</div>
                              <input style={{ ...S.input, fontSize: 12 }} value={editEx.name}
                                onChange={e => { const updated = (data.customExercises || []).map(ce => ce.id === ex.id ? { ...ce, name: e.target.value } : ce); setData({ ...data, customExercises: updated }); }} />
                            </div>
                            <div style={{ marginBottom: 8 }}>
                              <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 1, marginBottom: 3 }}>MUSCLE GROUP</div>
                              <input style={{ ...S.input, fontSize: 12 }} value={editEx.muscle}
                                onChange={e => { const updated = (data.customExercises || []).map(ce => ce.id === ex.id ? { ...ce, muscle: e.target.value } : ce); setData({ ...data, customExercises: updated }); }} />
                            </div>
                          </>
                        )}

                        <div style={{ marginBottom: 10 }}>
                          <div style={{ fontSize: 8, color: T.textMuted, letterSpacing: 1, marginBottom: 3 }}>VIDEO / HOW-TO LINK</div>
                          <input id={`video-${ex.id}`} style={{ ...S.input, fontSize: 11 }} defaultValue={videoUrl} placeholder="https://..." />
                        </div>

                        <div style={{ display: "flex", gap: 8 }}>
                          <button style={{ ...S.btn("#0ea5e9"), padding: "8px 14px", fontSize: 10 }}
                            onClick={() => {
                              const urlInput = document.getElementById(`video-${ex.id}`);
                              const newUrl = urlInput ? urlInput.value.trim() : videoUrl;
                              if (isCustom) {
                                const current = (data.customExercises || []).find(ce => ce.id === ex.id);
                                updateCustomExercise(ex.id, { name: current.name, muscle: current.muscle, videoUrl: newUrl });
                              } else {
                                updateExerciseVideo(ex.id, newUrl);
                              }
                            }}>SAVE</button>
                          <button onClick={() => setEditingExercise(null)} style={{ ...S.btnOutline("#555"), padding: "8px 14px", fontSize: 10, width: "auto" }}>CANCEL</button>
                        </div>
                      </div>
                    );
                  }

                  return (
                    <div key={ex.id} style={{ ...S.card, marginBottom: 4, padding: "10px 14px" }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            <div style={{ fontSize: 12, fontWeight: 600, color: dark ? "#ddd" : "#333", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{ex.name}</div>
                            {isCustom && <span style={{ fontSize: 7, color: "#0ea5e9", background: "#0ea5e915", padding: "1px 5px", borderRadius: 3, letterSpacing: 0.5, fontWeight: 700 }}>CUSTOM</span>}
                            {isShared && <span style={{ fontSize: 7, color: "#22c55e", background: "#22c55e15", padding: "1px 5px", borderRadius: 3, letterSpacing: 0.5, fontWeight: 700 }}>SHARED</span>}
                          </div>
                          <div style={{ fontSize: 9, color: T.textMuted, marginTop: 2 }}>
                            {ex.muscle}
                            {isShared && sharedEx.addedByName && <span style={{ color: T.textFaint }}> Â· added by {sharedEx.addedByName}</span>}
                          </div>
                          <div style={{ display: "flex", gap: 8, marginTop: 4, alignItems: "center", flexWrap: "wrap" }}>
                            {videoUrl ? (
                              <a href={videoUrl} target="_blank" rel="noopener noreferrer"
                                style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 9, color: "#0ea5e9", textDecoration: "none" }}>
                                <LinkIcon /> How-to video
                              </a>
                            ) : <span style={{ fontSize: 9, color: T.textFaint }}>No video linked</span>}
                            {pr && <span style={{ fontSize: 9, color: "#22c55e" }}>PR: {pr} lb</span>}
                          </div>
                        </div>
                        <div style={{ display: "flex", gap: 4, flexShrink: 0, marginLeft: 8 }}>
                          <button onClick={() => setEditingExercise(ex.id)}
                            style={{ background: "none", border: `1px solid ${T.borderInput}`, borderRadius: 5, color: T.textMuted, cursor: "pointer", padding: "5px 7px", display: "flex", alignItems: "center" }}>
                            <EditIcon />
                          </button>
                          {isCustom && (
                            <button onClick={() => deleteCustomExercise(ex.id)}
                              style={{ background: "none", border: "1px solid #e9456022", borderRadius: 5, color: "#e94560", cursor: "pointer", padding: "5px 7px", display: "flex", alignItems: "center" }}>
                              <TrashIcon />
                            </button>
                          )}
                          {canDeleteShared && !isCustom && (
                            <button onClick={() => { if (confirm("Remove \"" + ex.name + "\" from the shared library?")) deleteSharedExercise(ex.id); }}
                              style={{ background: "none", border: "1px solid #e9456022", borderRadius: 5, color: "#e94560", cursor: "pointer", padding: "5px 7px", display: "flex", alignItems: "center" }}>
                              <TrashIcon />
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          })}
        </div>

        <div style={{ marginTop: 20, padding: 12, background: T.bgCard, borderRadius: 8, border: `1px solid ${T.border}` }}>
          <div style={{ fontSize: 9, color: T.textMuted, lineHeight: 1.6 }}>
            <strong style={{ color: T.textMuted }}>Built-in exercises</strong> â€” edit the video link anytime.<br />
            <strong style={{ color: "#0ea5e9" }}>Custom exercises</strong> â€” private to you, fully editable and deletable.<br />
            <strong style={{ color: "#22c55e" }}>Shared exercises</strong> â€” visible to all users. You can delete ones you added.
          </div>
        </div>

        {/* Danger zone */}
        <div style={{ marginTop: 40, padding: 14, borderRadius: 8, border: `1px solid #e9456022` }}>
          <div style={{ fontSize: 9, color: "#e94560", letterSpacing: 1, fontWeight: 700, marginBottom: 8 }}>âš  DANGER ZONE</div>
          <button onClick={() => {
            if (confirm("This will permanently delete ALL your workout data, custom exercises, and history. This cannot be undone.\n\nAre you sure?")) {
              if (confirm("FINAL WARNING: You are about to erase everything. Type-level confirmation â€” really delete all data?")) {
                clearAllData();
              }
            }
          }} style={{ background: "none", border: `1px solid #e9456033`, borderRadius: 6, color: "#e94560", cursor: "pointer", padding: "8px 14px", fontSize: 9, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5 }}>
            RESET ALL DATA
          </button>
        </div>
      </div>
    );
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUILD TEMPLATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const renderBuildTemplate = () => {
    if (!buildingTemplate) return null;
    const tpl = buildingTemplate;
    const categories = [...new Set(allExercises.map(e => e.category))];
    const selectedIds = new Set(tpl.exercises.map(e => e.exerciseId));

    const toggleExercise = (exId) => {
      if (selectedIds.has(exId)) {
        setBuildingTemplate({ ...tpl, exercises: tpl.exercises.filter(e => e.exerciseId !== exId) });
      } else {
        const ex = allExercises.find(e => e.id === exId);
        const lastWorking = getLastWorkingWeight(exId, data.workoutLogs);
        setBuildingTemplate({ ...tpl, exercises: [...tpl.exercises, {
          exerciseId: exId, name: ex.name, category: ex.category,
          targetWeight: lastWorking || 0, warmupWeight: lastWorking ? Math.round(lastWorking * 0.5 / 5) * 5 : 0,
          targetSets: 3, targetReps: 12, notes: ""
        }]});
      }
    };

    const updateExConfig = (exId, field, value) => {
      setBuildingTemplate({ ...tpl, exercises: tpl.exercises.map(e =>
        e.exerciseId === exId ? { ...e, [field]: value } : e
      )});
    };

    const saveTemplate = () => {
      if (!tpl.name.trim() || tpl.exercises.length === 0) return;
      saveAsTemplate(
        tpl.name,
        tpl.exercises.map(e => e.exerciseId),
        tpl.location,
        tpl.exercises.map(e => ({
          exerciseId: e.exerciseId,
          targetWeight: Number(e.targetWeight) || 0,
          warmupWeight: Number(e.warmupWeight) || 0,
          targetSets: Number(e.targetSets) || 3,
          targetReps: Number(e.targetReps) || 12,
          notes: e.notes || "",
        }))
      );
      setBuildingTemplate(null);
      setView("dashboard");
    };

    return (
      <div>
        <div style={{ ...S.sectionLabel, color: "#f59e0b", marginBottom: 14 }}><TemplateIcon /> BUILD TEMPLATE</div>

        <div style={{ marginBottom: 12 }}>
          <div style={{ fontSize: 9, color: T.textMuted, letterSpacing: 1, marginBottom: 4 }}>TEMPLATE NAME *</div>
          <input style={S.input} placeholder="e.g. Monday: Posterior Chain + Back" value={tpl.name}
            onChange={e => setBuildingTemplate({ ...tpl, name: e.target.value })} />
        </div>

        <div style={{ marginBottom: 16 }}>
          <div style={{ ...S.sectionLabel, color: T.textMuted }}><MapPinIcon /> Location</div>
          <input style={S.input} placeholder="e.g. Tom Muehlenbeck" value={tpl.location}
            onChange={e => setBuildingTemplate({ ...tpl, location: e.target.value })} />
          {getRecentGyms().length > 0 && (
            <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginTop: 6 }}>
              {getRecentGyms().map((gym, i) => (
                <button key={i} onClick={() => setBuildingTemplate({ ...tpl, location: gym })}
                  style={{ background: T.bgInset, border: `1px solid ${T.borderInput}`, borderRadius: 6, padding: "4px 8px", fontSize: 9, color: T.text, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace" }}>
                  {gym}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Selected exercises with configs */}
        {tpl.exercises.length > 0 && (
          <div style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 9, color: T.textFaint, letterSpacing: 1, marginBottom: 8 }}>EXERCISES IN TEMPLATE ({tpl.exercises.length})</div>
            {tpl.exercises.map((exCfg, i) => {
              const catInfo = CATEGORY_COLORS[exCfg.category] || { accent: "#888" };
              return (
                <div key={exCfg.exerciseId} style={{ ...S.card, marginBottom: 6, padding: "12px 14px", borderColor: catInfo.accent + "33" }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: T.textStrong }}>{exCfg.name}</div>
                      <div style={{ fontSize: 8, color: catInfo.accent }}>{(CATEGORY_COLORS[exCfg.category] || {}).label}</div>
                    </div>
                    <button onClick={() => toggleExercise(exCfg.exerciseId)}
                      style={{ background: "none", border: "none", color: "#e94560", cursor: "pointer", padding: 4 }}><XIcon /></button>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 6 }}>
                    <div>
                      <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>WORKING</div>
                      <input type="number" style={{ ...S.input, fontSize: 11, padding: "6px 8px", textAlign: "center" }} value={exCfg.targetWeight}
                        onChange={e => updateExConfig(exCfg.exerciseId, "targetWeight", e.target.value)} />
                      <div style={{ fontSize: 7, color: T.textFaint, textAlign: "center", marginTop: 1 }}>lb</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>WARMUP</div>
                      <input type="number" style={{ ...S.input, fontSize: 11, padding: "6px 8px", textAlign: "center" }} value={exCfg.warmupWeight}
                        onChange={e => updateExConfig(exCfg.exerciseId, "warmupWeight", e.target.value)} />
                      <div style={{ fontSize: 7, color: T.textFaint, textAlign: "center", marginTop: 1 }}>lb</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>SETS</div>
                      <input type="number" style={{ ...S.input, fontSize: 11, padding: "6px 8px", textAlign: "center" }} value={exCfg.targetSets}
                        onChange={e => updateExConfig(exCfg.exerciseId, "targetSets", e.target.value)} />
                    </div>
                    <div>
                      <div style={{ fontSize: 7, color: T.textFaint, letterSpacing: 0.5, marginBottom: 2 }}>REPS</div>
                      <input type="number" style={{ ...S.input, fontSize: 11, padding: "6px 8px", textAlign: "center" }} value={exCfg.targetReps}
                        onChange={e => updateExConfig(exCfg.exerciseId, "targetReps", e.target.value)} />
                    </div>
                  </div>
                  <div style={{ marginTop: 6 }}>
                    <input style={{ ...S.input, fontSize: 10 }} placeholder="Notes (optional)" value={exCfg.notes}
                      onChange={e => updateExConfig(exCfg.exerciseId, "notes", e.target.value)} />
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* Exercise picker */}
        <div style={{ fontSize: 9, color: T.textFaint, letterSpacing: 1, marginBottom: 8 }}>TAP TO ADD EXERCISES</div>
        {categories.map(cat => {
          const catInfo = CATEGORY_COLORS[cat];
          const catExercises = allExercises.filter(e => e.category === cat);
          if (catExercises.length === 0) return null;
          return (
            <div key={cat} style={{ marginBottom: 12 }}>
              <div style={S.tag(catInfo.accent)}>{catInfo.label}</div>
              {catExercises.map(ex => {
                const selected = selectedIds.has(ex.id);
                return (
                  <div key={ex.id} onClick={() => toggleExercise(ex.id)}
                    style={{ ...S.card, marginBottom: 3, padding: "8px 12px", cursor: "pointer", borderColor: selected ? catInfo.accent + "66" : T.border, opacity: selected ? 0.5 : 1, transition: "all 0.15s" }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                      <div style={{ fontSize: 11, fontWeight: 600, color: selected ? T.textMuted : T.textStrong }}>{ex.name}</div>
                      <div style={{ width: 18, height: 18, borderRadius: 4, border: `2px solid ${selected ? catInfo.accent : T.borderInput}`, background: selected ? catInfo.accent + "20" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: catInfo.accent }}>
                        {selected && <CheckIcon />}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          );
        })}

        {/* Save / Cancel */}
        {tpl.exercises.length > 0 && (
          <div style={{ position: "sticky", bottom: 70, paddingTop: 12 }}>
            <button style={S.btn("#f59e0b")} onClick={saveTemplate}>
              <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><TemplateIcon /> SAVE TEMPLATE ({tpl.exercises.length} EXERCISES)</span>
            </button>
          </div>
        )}
        <button onClick={() => { setBuildingTemplate(null); setView("dashboard"); }} style={{ ...S.btnOutline("#555"), marginTop: 8 }}>CANCEL</button>
      </div>
    );
  };

  return (
    <div style={S.app}>
      <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      <div style={S.header}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
            <span style={{ color: "#e94560" }}><DumbbellIcon /></span>
            <span style={S.title}>WORKOUT TRACKER</span>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            <button onClick={() => setShowHelp(true)} style={S.themeToggle} title="Help">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </button>
            <button onClick={toggleTheme} style={S.themeToggle}>
              {dark ? <SunIcon /> : <MoonIcon />}
            </button>
          </div>
        </div>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 6 }}>
          <div style={S.subtitle}>GetNerdyIn30.com <span style={{ color: T.textFaint, marginLeft: 4 }}>v{APP_VERSION}</span></div>
          {user && (
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              {user.photo && <img src={user.photo} alt="" style={{ width: 18, height: 18, borderRadius: "50%" }} />}
              <span style={{ fontSize: 9, color: T.textMuted }}>{user.name?.split(" ")[0]}</span>
              <button onClick={handleSignOut} style={{ background: "none", border: "none", color: T.textFaint, cursor: "pointer", fontSize: 8, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5, textDecoration: "underline" }}>SIGN OUT</button>
            </div>
          )}
        </div>
      </div>

      {view === "dashboard" && renderDashboard()}
      {view === "build" && renderBuild()}
      {view === "buildTemplate" && renderBuildTemplate()}
      {view === "active" && renderActive()}
      {view === "progress" && renderProgress()}
      {view === "prs" && renderPRs()}
      {view === "history" && renderHistory()}
      {view === "library" && renderLibrary()}

      {view !== "active" && (
        <div style={S.nav}>
          {[
            { id: "dashboard", icon: <DumbbellIcon />, label: "WORKOUT" },
            { id: "history", icon: <HistoryIcon />, label: "HISTORY" },
            { id: "library", icon: <LibraryIcon />, label: "EXERCISES" },
            { id: "progress", icon: <ChartIcon />, label: "PROGRESS" },
            { id: "prs", icon: <TrophyIcon />, label: "PRs" },
          ].map(tab => (
            <button key={tab.id} style={S.navBtn(view === tab.id)} onClick={() => setView(tab.id)}>
              {tab.icon}<span>{tab.label}</span>
            </button>
          ))}
        </div>
      )}

      {/* Save as Template Modal */}
      {showSaveTemplate && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200, padding: 20 }}
          onClick={() => setShowSaveTemplate(false)}>
          <div onClick={e => e.stopPropagation()}
            style={{ background: T.bgCard, border: `1px solid ${T.border}`, borderRadius: 16, padding: 24, maxWidth: 360, width: "100%" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 16 }}>
              <span style={{ color: "#f59e0b" }}><TemplateIcon /></span>
              <div style={{ fontSize: 14, fontWeight: 800, color: T.textStrong }}>Save as Template?</div>
            </div>
            <div style={{ fontSize: 11, color: T.textMuted, marginBottom: 16, lineHeight: 1.5 }}>
              Save this workout as a template so you can start it with one tap next time.
            </div>
            <div style={{ marginBottom: 14 }}>
              <div style={{ fontSize: 9, color: T.textFaint, letterSpacing: 1, marginBottom: 4 }}>TEMPLATE NAME</div>
              <input style={S.input} value={templateName} onChange={e => setTemplateName(e.target.value)} placeholder="e.g. Monday: Posterior Chain + Back" />
            </div>
            <div style={{ fontSize: 9, color: T.textFaint, marginBottom: 14 }}>
              {showSaveTemplate.exerciseIds?.length} exercises{showSaveTemplate.location ? ` Â· ðŸ“ ${showSaveTemplate.location}` : ""}
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button style={{ ...S.btn("#f59e0b"), flex: 1 }} onClick={() => {
                if (templateName.trim()) {
                  saveAsTemplate(templateName, showSaveTemplate.exerciseIds, showSaveTemplate.location, showSaveTemplate.exerciseConfigs, showSaveTemplate.warmupNotes, showSaveTemplate.cooldownNotes);
                  setShowSaveTemplate(false);
                  setTemplateName("");
                }
              }}>
                <span style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}><TemplateIcon /> SAVE TEMPLATE</span>
              </button>
              <button style={{ ...S.btnOutline("#555"), flex: 0, width: "auto", padding: "10px 16px" }} onClick={() => { setShowSaveTemplate(false); setTemplateName(""); }}>
                SKIP
              </button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ HELP / USER GUIDE MODAL â”€â”€ */}
      {showHelp && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.8)", display: "flex", alignItems: "flex-start", justifyContent: "center", zIndex: 300, padding: 16, overflowY: "auto" }}
          onClick={() => setShowHelp(false)}>
          <div style={{ background: T.bgCard, borderRadius: 12, padding: 0, maxWidth: 500, width: "100%", marginTop: 40, marginBottom: 40, border: `1px solid ${T.border}`, overflow: "hidden" }}
            onClick={e => e.stopPropagation()}>

            {/* Header */}
            <div style={{ padding: "16px 20px", borderBottom: `1px solid ${T.borderSubtle}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 15, fontWeight: 800, color: T.textStrong, letterSpacing: -0.5 }}>Quick Start Guide</span>
              <button onClick={() => setShowHelp(false)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", padding: 4 }}><XIcon /></button>
            </div>

            <div style={{ padding: "16px 20px", fontSize: 12, color: T.text, lineHeight: 1.8, maxHeight: "70vh", overflowY: "auto" }}>

              {/* Starting a Workout */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#e94560", letterSpacing: 1, marginBottom: 8 }}>STARTING A WORKOUT</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Tap <strong style={{ color: T.textStrong }}>Start New Workout</strong> to pick exercises manually, or tap a saved <strong style={{ color: T.textStrong }}>template</strong> on the dashboard to jump right in. You can set the date and gym location before starting.
              </div>

              {/* Warmup vs Working */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#f59e0b", letterSpacing: 1, marginBottom: 8 }}>WARMUP vs WORKING SETS</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Each exercise has two sections. <strong style={{ color: "#f59e0b" }}>Warmup</strong> is a lighter weight to groove your form (maybe 50% of your working weight for 6 reps). <strong style={{ color: "#22c55e" }}>Working sets</strong> are your real weight. Tap the set button to mark it complete, then enter your reps.
              </div>

              {/* Per-Set Weight */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#22c55e", letterSpacing: 1, marginBottom: 8 }}>CHANGING WEIGHT PER SET</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                The top weight field sets the default for all sets. To change weight on a specific set (like bumping up on your last set), edit the weight number on that individual set row. It'll show <strong style={{ color: "#f59e0b" }}>BUMPED</strong> to confirm it's different from your default.
              </div>

              {/* Add/Remove Mid-Workout */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1, marginBottom: 8 }}>ADD OR REMOVE EXERCISES</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                During a workout, tap the blue <strong style={{ color: "#0ea5e9" }}>Add Exercise</strong> button below your exercises to add more. To remove one, tap the <strong style={{ color: "#e94560" }}>X</strong> in the top-right corner of any exercise card. You can also add and remove sets using the + SET / - SET buttons.
              </div>

              {/* Templates */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#f59e0b", letterSpacing: 1, marginBottom: 8 }}>TEMPLATES</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Templates are for <strong style={{ color: T.textStrong }}>recurring routines</strong> you do regularly (like "Full Body Day"). Tap <strong style={{ color: T.textStrong }}>Create Template</strong> on the dashboard to build one, or finish any workout and you'll be asked to save it as a template. Tap a template on the dashboard to <strong style={{ color: T.textStrong }}>review and edit</strong> â€” change the name, add or remove exercises, adjust warmup/working weights, sets, and reps. Hit <strong style={{ color: "#f59e0b" }}>Save Changes</strong> to update it, or <strong style={{ color: "#22c55e" }}>Start</strong> to launch the workout with all weights pre-loaded.
              </div>

              {/* Planned Workouts */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1, marginBottom: 8 }}>PLANNED WORKOUTS</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Planning is for <strong style={{ color: T.textStrong }}>specific dates</strong> â€” like designing Thursday's workout on Tuesday night. Tap any day on the calendar, then <strong style={{ color: "#0ea5e9" }}>Plan Workout For This Day</strong>. Pick your exercises and each one expands to show your <strong style={{ color: T.textStrong }}>last weight, suggested next weight,</strong> and editable fields for <strong style={{ color: "#f59e0b" }}>warmup weight</strong>, <strong style={{ color: "#22c55e" }}>working weight</strong>, sets, and reps. Set warmup and cooldown notes too (like "TRX squat & row" or "Tabata finisher"). Blue dots on the calendar mark planned days. On that day, your plan appears on the dashboard â€” tap it to review and edit, or start right away. All weights pre-load from your plan.
              </div>

              {/* Editing Plans */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#0ea5e9", letterSpacing: 1, marginBottom: 8 }}>EDITING A PLAN</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Tap a planned workout on the dashboard to open it in <strong style={{ color: T.textStrong }}>edit mode</strong>. You can change the name, warmup, cooldown, add or remove exercises, and adjust any weights. Hit <strong style={{ color: "#0ea5e9" }}>Save Changes</strong> to update the plan and go back, or <strong style={{ color: "#22c55e" }}>Start</strong> to save and begin the workout. From the calendar, you'll see both an <strong style={{ color: "#0ea5e9" }}>Edit Plan</strong> and <strong style={{ color: "#22c55e" }}>Start</strong> button.
              </div>

              {/* Light vs Heavy Days */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#22c55e", letterSpacing: 1, marginBottom: 8 }}>LIGHT vs HEAVY DAYS</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                When planning a workout, each exercise shows your <strong style={{ color: T.textStrong }}>last weight</strong> and a <strong style={{ color: "#22c55e" }}>suggested next weight</strong> (5% increase). For a light day, dial the working weight down. For a heavy day, bump it up. The warmup weight field is there too â€” typically ~50% of your working weight. Set it all the night before so you walk into the gym with zero decisions.
              </div>

              {/* Warmup & Cooldown */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#8b5cf6", letterSpacing: 1, marginBottom: 8 }}>WARMUP & COOLDOWN</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Every workout has a <strong style={{ color: "#f59e0b" }}>Warmup</strong> notes section at the top and a <strong style={{ color: "#8b5cf6" }}>Cooldown</strong> section at the bottom. Use these for what your trainer prescribes â€” leg swings, TRX, tabata finisher, stretching, foam rolling. You can also set these when planning a workout so they're ready when you start. Notes save with your workout and show up in history and exports.
              </div>

              {/* Cardio */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#ff6b35", letterSpacing: 1, marginBottom: 8 }}>CARDIO TRACKING</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                Cardio exercises (Spin, Rowing, Treadmill, etc.) have different fields: <strong style={{ color: T.textStrong }}>duration, distance, calories, and heart rate</strong>. Fill in what you know from your machine or watch, add notes about the class or how it felt, and tap Mark Complete.
              </div>

              {/* Exercises & Library */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#8b5cf6", letterSpacing: 1, marginBottom: 8 }}>EXERCISE LIBRARY</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                The <strong style={{ color: T.textStrong }}>Exercises</strong> tab shows all available exercises. You can add custom exercises, link how-to videos, and share exercises with the community. There are three types: <strong>built-in</strong> (always there), <strong style={{ color: "#0ea5e9" }}>custom</strong> (private to you), and <strong style={{ color: "#22c55e" }}>shared</strong> (visible to everyone).
              </div>

              {/* Progress & PRs */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#22c55e", letterSpacing: 1, marginBottom: 8 }}>PROGRESS & PRs</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                The <strong style={{ color: T.textStrong }}>Progress</strong> tab shows your weight over time for each exercise. The <strong style={{ color: T.textStrong }}>PRs</strong> tab tracks your personal records. The app auto-detects new PRs during workouts and celebrates them.
              </div>

              {/* History */}
              <div style={{ fontSize: 11, fontWeight: 700, color: "#ec4899", letterSpacing: 1, marginBottom: 8 }}>HISTORY & EDITING</div>
              <div style={{ marginBottom: 16, color: T.textMuted, fontSize: 11 }}>
                The <strong style={{ color: T.textStrong }}>History</strong> tab shows all past workouts. Tap any workout to expand it and see every set. You can <strong style={{ color: "#0ea5e9" }}>edit</strong> a past workout, <strong style={{ color: "#e94560" }}>delete</strong> it, or <strong>copy/share</strong> it as formatted text.
              </div>

              {/* Tips */}
              <div style={{ fontSize: 11, fontWeight: 700, color: T.textStrong, letterSpacing: 1, marginBottom: 8 }}>TIPS</div>
              <div style={{ marginBottom: 8, color: T.textMuted, fontSize: 11 }}>
                <strong style={{ color: T.textStrong }}>Auto-populated weights:</strong> The app remembers your last weight for each exercise and suggests a 5% increase next time.
              </div>
              <div style={{ marginBottom: 8, color: T.textMuted, fontSize: 11 }}>
                <strong style={{ color: T.textStrong }}>Dark/Light mode:</strong> Tap the sun/moon icon in the header. Your preference is saved.
              </div>
              <div style={{ marginBottom: 8, color: T.textMuted, fontSize: 11 }}>
                <strong style={{ color: T.textStrong }}>Syncs everywhere:</strong> Your data is saved to the cloud. Log in on any device and everything is there.
              </div>
              <div style={{ color: T.textMuted, fontSize: 11, marginBottom: 8 }}>
                <strong style={{ color: T.textStrong }}>Backdate workouts:</strong> Forgot to log yesterday? Change the date before starting a workout.
              </div>
              <div style={{ color: T.textMuted, fontSize: 11 }}>
                <strong style={{ color: T.textStrong }}>Auto-save:</strong> Your active workout is continuously saved to the cloud. If your phone dies, the browser crashes, or you accidentally close the app, just re-open it â€” your workout picks up right where you left off. No more lost sets.
              </div>

              {/* Changelog */}
              <div style={{ fontSize: 11, fontWeight: 700, color: T.textStrong, letterSpacing: 1, marginBottom: 8 }}>CHANGELOG</div>
              {CHANGELOG.map(release => (
                <div key={release.version} style={{ marginBottom: 12 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 4 }}>
                    <span style={{ fontSize: 11, fontWeight: 700, color: "#e94560" }}>v{release.version}</span>
                    <span style={{ fontSize: 9, color: T.textFaint }}>{release.date}</span>
                  </div>
                  {release.changes.map((c, i) => (
                    <div key={i} style={{ fontSize: 10, color: T.textMuted, paddingLeft: 8, marginBottom: 2, lineHeight: 1.5 }}>â€¢ {c}</div>
                  ))}
                </div>
              ))}

            </div>

            {/* Footer */}
            <div style={{ padding: "12px 20px", borderTop: `1px solid ${T.borderSubtle}`, textAlign: "center" }}>
              <button onClick={() => setShowHelp(false)} style={{ ...S.btn("#e94560"), padding: "10px 20px" }}>GOT IT</button>
              <div style={{ fontSize: 8, color: T.textFaint, marginTop: 8 }}>v{APP_VERSION} Â· {APP_BUILD_DATE}</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Mount the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(WorkoutTracker));
</script>
</body>
</html>
